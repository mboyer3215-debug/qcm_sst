<!DOCTYPE html>
<html lang="fr" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QCM SST Synchronis√© - Formation Interactive</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap');

        * {
            font-family: 'Poppins', sans-serif;
        }

        @keyframes bounce-in {
            0% { transform: scale(0) rotate(-180deg); opacity: 0; }
            50% { transform: scale(1.1) rotate(10deg); }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }

        @keyframes confetti-fall {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(5deg); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 20px rgba(93, 92, 222, 0.5); }
            50% { box-shadow: 0 0 40px rgba(93, 92, 222, 0.8), 0 0 60px rgba(93, 92, 222, 0.6); }
        }

        .bounce-in { animation: bounce-in 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
        .confetti { animation: confetti-fall 3s linear; }
        .float { animation: float 3s ease-in-out infinite; }
        .pulse-anim { animation: pulse 1s ease-in-out infinite; }
        .glow { animation: glow 2s ease-in-out infinite; }

        .glass-morphism {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .dark .glass-morphism {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .neon-text {
            text-shadow: 0 0 10px rgba(93, 92, 222, 0.8),
                         0 0 20px rgba(93, 92, 222, 0.6),
                         0 0 30px rgba(93, 92, 222, 0.4);
        }

        .matching-item {
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .matching-item.selected {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(93, 92, 222, 0.8);
        }

        .puzzle-piece {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: 2px solid white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: white;
            text-align: center;
            padding: 10px;
            min-height: 60px;
        }

        .puzzle-piece:hover {
            transform: rotateY(10deg) scale(1.05);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        .puzzle-piece.correct {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }

        .sequence-item {
            transition: all 0.3s;
            cursor: pointer;
        }

        .sequence-item:hover {
            transform: translateY(-5px);
        }

        .ranking-badge {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }

        .rank-1 { background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); }
        .rank-2 { background: linear-gradient(135deg, #C0C0C0 0%, #808080 100%); }
        .rank-3 { background: linear-gradient(135deg, #CD7F32 0%, #8B4513 100%); }
        .rank-other { background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                    }
                }
            }
        }
    </script>
</head>
<body class="h-full bg-gradient-to-br from-indigo-100 via-purple-50 to-pink-100 dark:from-gray-900 dark:via-purple-900 dark:to-gray-800">
    <!-- Confetti Container -->
    <div id="confetti-container" class="fixed inset-0 pointer-events-none z-50"></div>

    <div id="app" class="min-h-screen p-4 md:p-8">

        <!-- √âcran de connexion Superviseur -->
        <div id="supervisor-login" class="max-w-md mx-auto">
            <div class="text-center mb-8 bounce-in">
                <div class="text-8xl mb-6">üë®‚Äçüè´</div>
                <h1 class="text-4xl md:text-5xl font-bold text-primary mb-4">QCM SST Synchronis√©</h1>
                <p class="text-lg text-gray-700 dark:text-gray-300">Formation Interactive</p>
            </div>

            <div class="glass-morphism rounded-3xl shadow-2xl p-8 bounce-in" style="animation-delay: 0.2s">
                <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-6 text-center">Connexion Superviseur</h2>

                <form id="supervisor-login-form" class="space-y-6">
                    <div>
                        <label for="supervisor-password" class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">
                            Mot de passe
                        </label>
                        <input
                            type="password"
                            id="supervisor-password"
                            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                            class="w-full px-4 py-3 border-2 border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-800 dark:text-white text-base focus:border-primary focus:outline-none"
                            required
                        >
                    </div>

                    <div id="login-error" class="hidden text-red-600 dark:text-red-400 text-sm font-semibold text-center bg-red-50 dark:bg-red-900/20 p-3 rounded-lg">
                        ‚ùå Mot de passe incorrect
                    </div>

                    <button
                        type="submit"
                        class="w-full bg-gradient-to-r from-primary via-purple-600 to-pink-600 text-white text-xl font-bold py-4 rounded-xl shadow-lg hover:shadow-2xl transform hover:scale-105 transition-all"
                    >
                        üîì D√©verrouiller
                    </button>
                </form>
            </div>
        </div>

        <!-- √âcran Tableau de bord Superviseur -->
        <div id="supervisor-dashboard" class="hidden max-w-6xl mx-auto">
            <div class="text-center mb-6">
                <h1 class="text-4xl md:text-5xl font-bold text-primary neon-text mb-2">üë®‚Äçüè´ Tableau de Bord Superviseur</h1>
                <p class="text-lg text-gray-600 dark:text-gray-400">Gestion de la session QCM SST</p>
            </div>

            <!-- QR Code Section -->
            <div class="glass-morphism rounded-3xl shadow-2xl p-8 mb-6 text-center">
                <h3 class="text-2xl font-bold text-gray-800 dark:text-white mb-4">üì± Connexion Stagiaires</h3>
                <p class="text-gray-600 dark:text-gray-400 mb-4">Scannez ce QR code pour rejoindre la session</p>
                <div id="qrcode-container" class="inline-block p-4 bg-white rounded-xl mb-4"></div>
                <p class="text-sm text-gray-500 dark:text-gray-500">Session ID: <span id="session-id-display"></span></p>
            </div>

            <!-- Teams Connected -->
            <div class="glass-morphism rounded-3xl shadow-2xl p-8 mb-6">
                <h3 class="text-2xl font-bold text-gray-800 dark:text-white mb-4">üë• √âquipes connect√©es (<span id="teams-count">0</span>)</h3>
                <div id="teams-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div class="text-center text-gray-500 dark:text-gray-400">En attente des √©quipes...</div>
                </div>
            </div>

            <!-- Control Buttons -->
            <div class="flex flex-col md:flex-row gap-4 mb-6">
                <button id="start-game-btn" class="flex-1 bg-gradient-to-r from-green-500 to-emerald-600 text-white text-xl font-bold py-5 rounded-xl shadow-lg hover:shadow-2xl transform hover:scale-105 transition-all">
                    üöÄ Lancer le Jeu
                </button>
                <button id="reset-game-btn" class="px-8 bg-gradient-to-r from-red-500 to-red-600 text-white text-xl font-bold py-5 rounded-xl shadow-lg hover:shadow-2xl transform hover:scale-105 transition-all">
                    üîÑ R√©initialiser
                </button>
            </div>
        </div>

        <!-- √âcran de connexion Stagiaire -->
        <div id="trainee-login" class="hidden max-w-md mx-auto">
            <div class="text-center mb-8 bounce-in">
                <h1 class="text-5xl md:text-7xl font-bold neon-text text-primary mb-4">üèÜ QCM SST</h1>
                <p class="text-xl md:text-2xl text-gray-700 dark:text-gray-300 font-semibold">Formation Interactive</p>
            </div>

            <div class="glass-morphism rounded-3xl shadow-2xl p-8 text-center bounce-in">
                <div class="text-6xl mb-4">üë•</div>
                <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-4">Rejoindre la session</h2>
                <p class="text-gray-600 dark:text-gray-400 mb-6">Entrez le nom de votre √©quipe</p>

                <input
                    type="text"
                    id="team-name-input"
                    placeholder="Nom de votre √©quipe"
                    class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-800 dark:text-white mb-4 text-base focus:border-primary focus:outline-none"
                    maxlength="20"
                >

                <button id="join-game-btn" class="w-full bg-gradient-to-r from-primary via-purple-600 to-pink-600 text-white text-xl font-bold py-4 rounded-xl shadow-lg hover:shadow-2xl transform hover:scale-105 transition-all">
                    üöÄ Rejoindre
                </button>
            </div>
        </div>

        <!-- √âcran Coffres (Superviseur apr√®s d√©marrage) -->
        <div id="boxes-screen" class="hidden max-w-7xl mx-auto">
            <div class="text-center mb-6">
                <h1 class="text-4xl md:text-5xl font-bold text-primary neon-text mb-4">üéÅ Les Coffres au Tr√©sor SST</h1>
                <div class="text-xl text-gray-700 dark:text-gray-300">
                    Cliquez sur un coffre pour lancer les questions
                </div>
            </div>

            <div id="boxes-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8 mb-8">
                <!-- Les coffres seront g√©n√©r√©s ici -->
            </div>
        </div>

        <!-- √âcran Attente Stagiaire -->
        <div id="trainee-waiting" class="hidden max-w-5xl mx-auto text-center">
            <div class="glass-morphism rounded-3xl shadow-2xl p-12 bounce-in">
                <div class="text-8xl mb-6">‚è≥</div>
                <h1 class="text-5xl md:text-6xl font-bold text-primary neon-text mb-6">En attente...</h1>
                <p class="text-2xl text-gray-700 dark:text-gray-300 mb-8">Le superviseur va lancer le jeu</p>

                <div class="bg-gradient-to-r from-primary via-purple-600 to-pink-600 text-white rounded-2xl p-8 shadow-2xl">
                    <div class="text-5xl font-bold mb-3" id="trainee-team-name-display"></div>
                    <div class="text-xl">Vous √™tes connect√© !</div>
                </div>

                <div class="mt-8 flex items-center justify-center space-x-2">
                    <div class="w-3 h-3 bg-primary rounded-full animate-bounce" style="animation-delay: 0s"></div>
                    <div class="w-3 h-3 bg-primary rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                    <div class="w-3 h-3 bg-primary rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
                </div>
            </div>
        </div>

        <!-- √âcran Projecteur (Question) -->
        <div id="projector-question" class="hidden max-w-7xl mx-auto">
            <div class="glass-morphism rounded-3xl shadow-2xl p-8 mb-6">
                <div class="text-center mb-6">
                    <div class="text-6xl mb-4" id="projector-game-icon">üéØ</div>
                    <h2 class="text-3xl md:text-4xl font-bold text-primary mb-4" id="projector-question-text">Question...</h2>
                </div>

                <!-- Container du jeu (sera rempli dynamiquement) -->
                <div id="projector-game-container" class="mb-6">
                    <!-- Le jeu sera ins√©r√© ici -->
                </div>

                <!-- Compteur de r√©ponses -->
                <div class="text-center">
                    <div class="inline-block bg-white dark:bg-gray-800 px-8 py-4 rounded-2xl shadow-lg">
                        <div class="text-2xl font-bold text-primary">
                            <span id="answered-count">0</span> / <span id="total-teams-count">0</span> √©quipes ont r√©pondu
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- √âcran Projecteur (Correction) -->
        <div id="projector-correction" class="hidden max-w-7xl mx-auto">
            <div class="glass-morphism rounded-3xl shadow-2xl p-8 mb-6 text-center">
                <div class="text-8xl mb-6">‚úÖ</div>
                <h2 class="text-4xl md:text-5xl font-bold text-green-600 mb-6">CORRECTION</h2>

                <div id="projector-correction-content" class="mb-8">
                    <!-- Correction sera affich√©e ici -->
                </div>

                <div class="bg-blue-50 dark:bg-blue-900 rounded-2xl p-6 mb-6">
                    <div class="text-2xl font-bold text-gray-800 dark:text-white mb-2">üí° Explication</div>
                    <p class="text-lg text-gray-700 dark:text-gray-300" id="projector-explanation">...</p>
                </div>

                <button id="next-question-btn" class="bg-gradient-to-r from-green-500 to-emerald-600 text-white text-2xl font-bold py-5 px-12 rounded-xl shadow-lg hover:shadow-2xl transform hover:scale-105 transition-all">
                    Question Suivante ‚Üí
                </button>
            </div>
        </div>

        <!-- √âcran Stagiaire (Jeu) -->
        <div id="trainee-game" class="hidden max-w-6xl mx-auto">
            <div class="glass-morphism rounded-2xl shadow-xl p-6 mb-6">
                <div class="flex justify-between items-center">
                    <div class="text-2xl font-bold text-primary" id="trainee-team-display"></div>
                    <div class="text-3xl font-bold text-green-600" id="trainee-score-display">0 pts</div>
                </div>
            </div>

            <!-- Container du jeu -->
            <div id="trainee-game-container" class="glass-morphism rounded-3xl shadow-2xl p-8 mb-6">
                <!-- Le jeu sera ins√©r√© ici -->
            </div>

            <!-- Bouton Valider -->
            <button id="trainee-validate-btn" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white text-2xl font-bold py-5 rounded-xl shadow-lg hover:shadow-2xl transform hover:scale-105 transition-all">
                ‚úì Valider ma r√©ponse
            </button>
        </div>

        <!-- √âcran Stagiaire (Attente apr√®s validation) -->
        <div id="trainee-waiting-others" class="hidden max-w-5xl mx-auto text-center">
            <div class="glass-morphism rounded-3xl shadow-2xl p-12 bounce-in">
                <div class="text-8xl mb-6">‚è≥</div>
                <h1 class="text-5xl md:text-6xl font-bold text-primary neon-text mb-6">R√©ponse enregistr√©e !</h1>
                <p class="text-2xl text-gray-700 dark:text-gray-300 mb-8">En attente des autres √©quipes...</p>

                <div class="mt-8 flex items-center justify-center space-x-2">
                    <div class="w-3 h-3 bg-primary rounded-full animate-bounce" style="animation-delay: 0s"></div>
                    <div class="w-3 h-3 bg-primary rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                    <div class="w-3 h-3 bg-primary rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
                </div>
            </div>
        </div>

        <!-- √âcran Stagiaire (R√©sultat) -->
        <div id="trainee-result" class="hidden max-w-5xl mx-auto text-center">
            <div class="glass-morphism rounded-3xl shadow-2xl p-12 bounce-in">
                <div class="text-8xl mb-6" id="trainee-result-icon">‚úì</div>
                <h1 class="text-5xl md:text-6xl font-bold mb-6" id="trainee-result-title">Bonne r√©ponse !</h1>

                <div class="bg-gradient-to-r from-primary via-purple-600 to-pink-600 text-white rounded-2xl p-10 mb-8 shadow-2xl">
                    <div class="text-7xl font-bold mb-3" id="trainee-points-earned">+150</div>
                    <div class="text-3xl font-semibold">Points gagn√©s</div>
                </div>

                <div class="bg-white dark:bg-gray-800 rounded-2xl p-6">
                    <div class="text-4xl font-bold text-primary mb-2" id="trainee-total-score">150</div>
                    <div class="text-xl text-gray-600 dark:text-gray-400">Score total</div>
                </div>
            </div>
        </div>

        <!-- √âcran Classement -->
        <div id="ranking-screen" class="hidden max-w-7xl mx-auto">
            <div class="glass-morphism rounded-3xl shadow-2xl p-8 text-center">
                <h2 class="text-4xl md:text-5xl font-bold text-primary neon-text mb-8">üèÜ CLASSEMENT</h2>

                <div id="ranking-list" class="space-y-4 mb-8">
                    <!-- Classement sera affich√© ici -->
                </div>

                <div class="text-center text-gray-600 dark:text-gray-400">
                    En attente de la prochaine question...
                </div>
            </div>
        </div>

        <!-- √âcran Pause entre Coffres -->
        <div id="pause-screen" class="hidden max-w-5xl mx-auto text-center">
            <div class="glass-morphism rounded-3xl shadow-2xl p-12 bounce-in">
                <div class="text-8xl mb-6">‚è∏Ô∏è</div>
                <h1 class="text-5xl md:text-6xl font-bold text-primary neon-text mb-6">Pause - Coffre <span id="pause-box-number">1</span> termin√© !</h1>
                <p class="text-2xl text-gray-700 dark:text-gray-300 mb-8">Atelier pratique en cours...</p>

                <div class="bg-gradient-to-r from-primary via-purple-600 to-pink-600 text-white rounded-2xl p-10 mb-8 shadow-2xl">
                    <div class="text-5xl font-bold mb-3">Classement actuel</div>
                </div>

                <div id="pause-ranking" class="bg-white dark:bg-gray-800 rounded-2xl p-6 mb-8">
                    <!-- Classement de pause -->
                </div>

                <button id="next-box-btn" class="bg-gradient-to-r from-green-500 to-emerald-600 text-white text-2xl font-bold py-5 px-12 rounded-xl shadow-lg hover:shadow-2xl transform hover:scale-105 transition-all">
                    ‚ñ∂Ô∏è Lancer Coffre <span id="next-box-number">2</span>
                </button>
            </div>
        </div>

        <!-- √âcran Podium Final -->
        <div id="podium-screen" class="hidden max-w-7xl mx-auto text-center">
            <div class="glass-morphism rounded-3xl shadow-2xl p-12 bounce-in">
                <div class="text-8xl mb-6">üèÜ</div>
                <h1 class="text-5xl md:text-6xl font-bold text-primary neon-text mb-8">MISSION ACCOMPLIE !</h1>

                <div class="flex justify-center items-end gap-8 mb-12">
                    <!-- Podium sera g√©n√©r√© ici -->
                    <div id="podium-container" class="flex justify-center items-end gap-4"></div>
                </div>

                <div id="full-ranking" class="bg-white dark:bg-gray-800 rounded-2xl p-8">
                    <h3 class="text-2xl font-bold mb-4">Classement Final</h3>
                    <div id="full-ranking-list"></div>
                </div>

                <button id="restart-game-btn" class="mt-8 bg-gradient-to-r from-primary via-purple-600 to-pink-600 text-white text-xl font-bold py-4 px-12 rounded-xl shadow-lg hover:shadow-2xl transform hover:scale-105 transition-all">
                    üîÑ Nouvelle Session
                </button>
            </div>
        </div>

    </div>

    <script>
// Configuration Firebase
const firebaseConfig = {
    apiKey: "AIzaSyAZLBDZIaPp3GrXuVz4fPiK91JhLEqXPs0",
    authDomain: "jeu-sst-v1-291025.firebaseapp.com",
    databaseURL: "https://jeu-sst-v1-291025-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "jeu-sst-v1-291025",
    storageBucket: "jeu-sst-v1-291025.firebasestorage.app",
    messagingSenderId: "57462613537",
    appId: "1:57462613537:web:6178195b2f4f08fbaa2560"
};

// Variables globales
let database = null;
let sessionId = null;
let userRole = null; // 'supervisor' ou 'trainee'
let teamName = null;
let currentBox = 0;
let currentGameIndex = 0;

// Mot de passe superviseur
const SUPERVISOR_PASSWORD = "sst2025";

// Initialiser Firebase
try {
    firebase.initializeApp(firebaseConfig);
    database = firebase.database();
    console.log('‚úÖ Firebase initialis√©');
} catch (error) {
    console.error('‚ùå Erreur Firebase:', error);
}

// Base de questions SST (exemples - √† compl√©ter)
const BOXES = [
    {
        name: "Coffre 1 - Les EPI",
        icon: "ü¶∫",
        color: "from-blue-500 to-cyan-600",
        games: [
            {
                type: "matching",
                question: "Associez chaque EPI √† sa fonction de protection",
                icon: "üéØ",
                pairs: [
                    { left: "Casque", right: "Prot√®ge la t√™te" },
                    { left: "Gants", right: "Prot√®ge les mains" },
                    { left: "Lunettes", right: "Prot√®ge les yeux" },
                    { left: "Chaussures de s√©curit√©", right: "Prot√®ge les pieds" }
                ],
                explanation: "Les EPI (√âquipements de Protection Individuelle) sont essentiels pour se prot√©ger des risques au travail."
            },
            {
                type: "sequence",
                question: "Ordonnez les √©tapes pour mettre un harnais de s√©curit√©",
                icon: "üìã",
                items: [
                    "V√©rifier l'√©tat du harnais",
                    "Enfiler le harnais",
                    "Ajuster les sangles",
                    "Accrocher le mousqueton"
                ],
                explanation: "L'ordre est crucial pour assurer une s√©curit√© maximale en hauteur."
            }
        ]
    },
    {
        name: "Coffre 2 - Pr√©vention Incendie",
        icon: "üî•",
        color: "from-red-500 to-orange-600",
        games: [
            {
                type: "matching",
                question: "Associez chaque extincteur √† son usage",
                icon: "üéØ",
                pairs: [
                    { left: "Extincteur √† eau", right: "Feux de classe A" },
                    { left: "Extincteur CO2", right: "Feux √©lectriques" },
                    { left: "Extincteur √† poudre", right: "Feux multiples" },
                    { left: "Extincteur mousse", right: "Feux d'hydrocarbures" }
                ],
                explanation: "Utiliser le bon extincteur selon le type de feu est vital pour une extinction efficace."
            },
            {
                type: "sequence",
                question: "Ordonnez les actions en cas d'alarme incendie",
                icon: "üìã",
                items: [
                    "Rester calme",
                    "Fermer portes et fen√™tres",
                    "Se diriger vers la sortie de secours",
                    "Rejoindre le point de rassemblement"
                ],
                explanation: "Une √©vacuation ordonn√©e sauve des vies en cas d'incendie."
            }
        ]
    },
    {
        name: "Coffre 3 - Premiers Secours",
        icon: "‚öïÔ∏è",
        color: "from-green-500 to-emerald-600",
        games: [
            {
                type: "sequence",
                question: "Ordonnez les √©tapes de la PLS (Position Lat√©rale de S√©curit√©)",
                icon: "üìã",
                items: [
                    "V√©rifier que la victime respire",
                    "Basculer la victime sur le c√¥t√©",
                    "Stabiliser la position",
                    "Surveiller la respiration"
                ],
                explanation: "La PLS √©vite l'√©touffement d'une victime inconsciente qui respire."
            },
            {
                type: "matching",
                question: "Associez chaque urgence √† son num√©ro d'appel",
                icon: "üéØ",
                pairs: [
                    { left: "SAMU", right: "15" },
                    { left: "Pompiers", right: "18" },
                    { left: "Police", right: "17" },
                    { left: "Urgence europ√©enne", right: "112" }
                ],
                explanation: "Conna√Ætre les num√©ros d'urgence permet de r√©agir rapidement."
            }
        ]
    },
    {
        name: "Coffre 4 - Signal√©tique",
        icon: "‚ö†Ô∏è",
        color: "from-yellow-500 to-amber-600",
        games: [
            {
                type: "matching",
                question: "Associez chaque panneau √† sa signification",
                icon: "üéØ",
                pairs: [
                    { left: "Triangle rouge", right: "Danger" },
                    { left: "Rond bleu", right: "Obligation" },
                    { left: "Rond rouge barr√©", right: "Interdiction" },
                    { left: "Carr√© vert", right: "Sauvetage/Secours" }
                ],
                explanation: "La signal√©tique de s√©curit√© utilise des formes et couleurs normalis√©es."
            },
            {
                type: "sequence",
                question: "Ordonnez les niveaux de risque (du plus faible au plus √©lev√©)",
                icon: "üìã",
                items: [
                    "Risque faible",
                    "Risque mod√©r√©",
                    "Risque √©lev√©",
                    "Risque critique"
                ],
                explanation: "L'√©valuation des risques permet de prioriser les actions de pr√©vention."
            }
        ]
    }
];

// Fonctions utilitaires
function showScreen(screenId) {
    document.querySelectorAll('#app > div').forEach(screen => {
        screen.classList.add('hidden');
    });
    document.getElementById(screenId).classList.remove('hidden');
}

function createConfetti() {
    const colors = ['#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A'];
    for (let i = 0; i < 50; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.position = 'fixed';
        confetti.style.width = '10px';
        confetti.style.height = '10px';
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.left = Math.random() * window.innerWidth + 'px';
        confetti.style.top = '-10px';
        confetti.style.zIndex = '9999';
        document.getElementById('confetti-container').appendChild(confetti);

        setTimeout(() => confetti.remove(), 3000);
    }
}

// Connexion Superviseur
document.getElementById('supervisor-login-form').addEventListener('submit', (e) => {
    e.preventDefault();
    const password = document.getElementById('supervisor-password').value;

    if (password === SUPERVISOR_PASSWORD) {
        userRole = 'supervisor';
        sessionId = 'session_' + Date.now();
        initializeSupervisor();
    } else {
        document.getElementById('login-error').classList.remove('hidden');
        setTimeout(() => {
            document.getElementById('login-error').classList.add('hidden');
        }, 3000);
    }
});

function initializeSupervisor() {
    showScreen('supervisor-dashboard');
    document.getElementById('session-id-display').textContent = sessionId;

    // Cr√©er le QR Code
    const qrContainer = document.getElementById('qrcode-container');
    qrContainer.innerHTML = '';
    const traineeUrl = window.location.href.split('?')[0] + '?session=' + sessionId;
    new QRCode(qrContainer, {
        text: traineeUrl,
        width: 256,
        height: 256,
        colorDark: '#5D5CDE',
        colorLight: '#ffffff',
        correctLevel: QRCode.CorrectLevel.H
    });

    // Initialiser la session Firebase
    database.ref('sessions/' + sessionId).set({
        status: 'waiting',
        currentBox: -1,
        currentGameIndex: -1,
        teams: {},
        createdAt: Date.now()
    });

    // √âcouter les nouvelles √©quipes
    database.ref('sessions/' + sessionId + '/teams').on('value', (snapshot) => {
        updateTeamsList(snapshot.val());
    });
}

function updateTeamsList(teams) {
    const teamsList = document.getElementById('teams-list');
    const teamsCount = document.getElementById('teams-count');

    if (!teams || Object.keys(teams).length === 0) {
        teamsList.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400">En attente des √©quipes...</div>';
        teamsCount.textContent = '0';
        return;
    }

    const teamsArray = Object.entries(teams);
    teamsCount.textContent = teamsArray.length;

    teamsList.innerHTML = teamsArray.map(([teamId, team]) => `
        <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow-lg text-center">
            <div class="text-3xl mb-2">${getTeamEmoji(teamId)}</div>
            <div class="text-lg font-bold text-gray-800 dark:text-white">${team.name}</div>
            <div class="text-sm text-gray-600 dark:text-gray-400">Score: ${team.score || 0} pts</div>
        </div>
    `).join('');
}

function getTeamEmoji(index) {
    const emojis = ['üöí', 'üöë', '‚ö°', 'üõ°Ô∏è', 'üî•', 'üí™', 'üéØ', '‚≠ê', 'üèÜ', 'üöÄ'];
    return emojis[parseInt(index) % emojis.length];
}

// D√©marrer le jeu
document.getElementById('start-game-btn').addEventListener('click', () => {
    database.ref('sessions/' + sessionId + '/status').set('playing');
    showBoxesScreen();
});

function showBoxesScreen() {
    showScreen('boxes-screen');

    const boxesContainer = document.getElementById('boxes-container');
    boxesContainer.innerHTML = BOXES.map((box, index) => `
        <div class="glass-morphism rounded-3xl shadow-2xl p-8 text-center cursor-pointer hover:scale-105 transition-all transform" onclick="openBox(${index})">
            <div class="text-8xl mb-4 float">${box.icon}</div>
            <h3 class="text-2xl font-bold text-gray-800 dark:text-white mb-2">${box.name}</h3>
            <div class="bg-gradient-to-r ${box.color} text-white px-6 py-3 rounded-xl font-bold text-lg mt-4">
                ${box.games.length} questions
            </div>
        </div>
    `).join('');
}

function openBox(boxIndex) {
    currentBox = boxIndex;
    currentGameIndex = 0;

    database.ref('sessions/' + sessionId).update({
        currentBox: boxIndex,
        currentGameIndex: 0,
        gameStatus: 'question'
    });

    loadGame();
}

function loadGame() {
    const game = BOXES[currentBox].games[currentGameIndex];

    // Afficher la question sur le projecteur
    showProjectorQuestion(game);

    // Envoyer le jeu aux stagiaires
    database.ref('sessions/' + sessionId + '/currentGame').set(game);
}

function showProjectorQuestion(game) {
    showScreen('projector-question');

    document.getElementById('projector-game-icon').textContent = game.icon;
    document.getElementById('projector-question-text').textContent = game.question;

    const container = document.getElementById('projector-game-container');

    if (game.type === 'matching') {
        container.innerHTML = `
            <div class="grid grid-cols-2 gap-8">
                <div class="space-y-4">
                    ${game.pairs.map((pair, i) => `
                        <div class="bg-gradient-to-r from-blue-500 to-cyan-600 text-white p-4 rounded-xl text-xl font-bold text-center">
                            ${pair.left}
                        </div>
                    `).join('')}
                </div>
                <div class="space-y-4">
                    ${game.pairs.map((pair, i) => `
                        <div class="bg-gradient-to-r from-purple-500 to-pink-600 text-white p-4 rounded-xl text-xl font-bold text-center">
                            ${pair.right}
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    } else if (game.type === 'sequence') {
        container.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                ${game.items.map((item, i) => `
                    <div class="puzzle-piece text-xl">
                        ${item}
                    </div>
                `).join('')}
            </div>
        `;
    }

    // √âcouter les r√©ponses
    listenForAnswers();
}

function listenForAnswers() {
    const teamsRef = database.ref('sessions/' + sessionId + '/teams');

    teamsRef.on('value', (snapshot) => {
        const teams = snapshot.val();
        if (!teams) return;

        const teamsArray = Object.values(teams);
        const answeredTeams = teamsArray.filter(t => t.hasAnswered).length;

        document.getElementById('answered-count').textContent = answeredTeams;
        document.getElementById('total-teams-count').textContent = teamsArray.length;

        // Si tous ont r√©pondu, afficher la correction
        if (answeredTeams === teamsArray.length && answeredTeams > 0) {
            setTimeout(() => showCorrection(), 1000);
        }
    });
}

function showCorrection() {
    const game = BOXES[currentBox].games[currentGameIndex];

    showScreen('projector-correction');
    document.getElementById('projector-explanation').textContent = game.explanation;

    // Afficher la correction selon le type
    const container = document.getElementById('projector-correction-content');

    if (game.type === 'matching') {
        container.innerHTML = `
            <div class="space-y-3">
                ${game.pairs.map((pair, i) => `
                    <div class="bg-green-100 dark:bg-green-900 p-4 rounded-xl text-lg font-bold">
                        ‚úì ${pair.left} ‚Üí ${pair.right}
                    </div>
                `).join('')}
            </div>
        `;
    } else if (game.type === 'sequence') {
        container.innerHTML = `
            <div class="space-y-3">
                ${game.items.map((item, i) => `
                    <div class="bg-green-100 dark:bg-green-900 p-4 rounded-xl text-lg font-bold">
                        ${i + 1}. ${item}
                    </div>
                `).join('')}
            </div>
        `;
    }

    // Calculer et afficher les scores
    calculateScores();
}

function calculateScores() {
    // Cette fonction calculera les scores en fonction des bonnes r√©ponses
    // Pour l'instant, on donne 150 pts √† tous (√† d√©velopper)
    database.ref('sessions/' + sessionId + '/teams').once('value', (snapshot) => {
        const teams = snapshot.val();
        Object.keys(teams).forEach(teamId => {
            const currentScore = teams[teamId].score || 0;
            const newScore = currentScore + 150; // Simplifi√© pour l'instant
            database.ref('sessions/' + sessionId + '/teams/' + teamId + '/score').set(newScore);
        });
    });
}

// Question suivante
document.getElementById('next-question-btn').addEventListener('click', () => {
    currentGameIndex++;

    if (currentGameIndex >= BOXES[currentBox].games.length) {
        // Coffre termin√©
        if (currentBox < BOXES.length - 1) {
            showPauseScreen();
        } else {
            showPodium();
        }
    } else {
        // Question suivante
        resetAnswers();
        loadGame();
    }
});

function resetAnswers() {
    database.ref('sessions/' + sessionId + '/teams').once('value', (snapshot) => {
        const teams = snapshot.val();
        Object.keys(teams).forEach(teamId => {
            database.ref('sessions/' + sessionId + '/teams/' + teamId + '/hasAnswered').set(false);
        });
    });
}

function showPauseScreen() {
    showScreen('pause-screen');
    document.getElementById('pause-box-number').textContent = currentBox + 1;
    document.getElementById('next-box-number').textContent = currentBox + 2;

    // Afficher classement
    displayRanking('pause-ranking');
}

function displayRanking(containerId) {
    database.ref('sessions/' + sessionId + '/teams').once('value', (snapshot) => {
        const teams = snapshot.val();
        if (!teams) return;

        const teamsArray = Object.entries(teams).map(([id, team]) => ({
            id,
            name: team.name,
            score: team.score || 0
        })).sort((a, b) => b.score - a.score);

        const container = document.getElementById(containerId);
        container.innerHTML = teamsArray.map((team, i) => `
            <div class="flex items-center justify-between p-4 ${i < 3 ? 'bg-gradient-to-r from-yellow-100 to-yellow-200 dark:from-yellow-900 dark:to-yellow-800' : 'bg-gray-100 dark:bg-gray-700'} rounded-lg mb-2">
                <div class="flex items-center gap-4">
                    <div class="ranking-badge rank-${i < 3 ? i + 1 : 'other'}">${i + 1}</div>
                    <div class="text-xl font-bold">${team.name}</div>
                </div>
                <div class="text-2xl font-bold text-primary">${team.score} pts</div>
            </div>
        `).join('');
    });
}

// Coffre suivant
document.getElementById('next-box-btn').addEventListener('click', () => {
    showBoxesScreen();
});

function showPodium() {
    showScreen('podium-screen');
    createConfetti();

    database.ref('sessions/' + sessionId + '/teams').once('value', (snapshot) => {
        const teams = snapshot.val();
        if (!teams) return;

        const teamsArray = Object.entries(teams).map(([id, team]) => ({
            id,
            name: team.name,
            score: team.score || 0
        })).sort((a, b) => b.score - a.score);

        // Podium top 3
        const podiumContainer = document.getElementById('podium-container');
        podiumContainer.innerHTML = '';

        if (teamsArray.length >= 2) {
            // 2√®me place
            podiumContainer.innerHTML += `
                <div class="text-center">
                    <div class="text-6xl mb-2">ü•à</div>
                    <div class="bg-gradient-to-r from-gray-300 to-gray-400 text-white p-6 rounded-t-xl" style="height: 200px; display: flex; flex-direction: column; justify-content: center;">
                        <div class="text-2xl font-bold">${teamsArray[1].name}</div>
                        <div class="text-4xl font-bold">${teamsArray[1].score} pts</div>
                    </div>
                </div>
            `;
        }

        if (teamsArray.length >= 1) {
            // 1√®re place
            podiumContainer.innerHTML += `
                <div class="text-center">
                    <div class="text-8xl mb-2">ü•á</div>
                    <div class="bg-gradient-to-r from-yellow-400 to-yellow-600 text-white p-8 rounded-t-xl" style="height: 300px; display: flex; flex-direction: column; justify-content: center;">
                        <div class="text-3xl font-bold">${teamsArray[0].name}</div>
                        <div class="text-5xl font-bold">${teamsArray[0].score} pts</div>
                    </div>
                </div>
            `;
        }

        if (teamsArray.length >= 3) {
            // 3√®me place
            podiumContainer.innerHTML += `
                <div class="text-center">
                    <div class="text-6xl mb-2">ü•â</div>
                    <div class="bg-gradient-to-r from-orange-400 to-orange-600 text-white p-4 rounded-t-xl" style="height: 150px; display: flex; flex-direction: column; justify-content: center;">
                        <div class="text-xl font-bold">${teamsArray[2].name}</div>
                        <div class="text-3xl font-bold">${teamsArray[2].score} pts</div>
                    </div>
                </div>
            `;
        }

        // Classement complet
        displayRanking('full-ranking-list');
    });
}

// Connexion Stagiaire via URL
window.addEventListener('DOMContentLoaded', () => {
    const urlParams = new URLSearchParams(window.location.search);
    const sessionParam = urlParams.get('session');

    if (sessionParam) {
        sessionId = sessionParam;
        userRole = 'trainee';
        showScreen('trainee-login');
    }
});

// Rejoindre le jeu
document.getElementById('join-game-btn').addEventListener('click', () => {
    teamName = document.getElementById('team-name-input').value.trim();

    if (!teamName) {
        showCustomAlert('Veuillez entrer un nom d\'√©quipe');
        return;
    }

    // G√©n√©rer un ID unique pour l'√©quipe
    const teamId = Date.now().toString();

    // Ajouter l'√©quipe √† Firebase
    database.ref('sessions/' + sessionId + '/teams/' + teamId).set({
        name: teamName,
        score: 0,
        hasAnswered: false,
        joinedAt: Date.now()
    });

    // Afficher √©cran d'attente
    showScreen('trainee-waiting');
    document.getElementById('trainee-team-name-display').textContent = teamName;

    // √âcouter les changements de statut
    database.ref('sessions/' + sessionId + '/status').on('value', (snapshot) => {
        const status = snapshot.val();
        if (status === 'playing') {
            // Le jeu a d√©marr√©, √©couter le jeu actuel
            listenForGameUpdates(teamId);
        }
    });
});

function listenForGameUpdates(teamId) {
    database.ref('sessions/' + sessionId + '/currentGame').on('value', (snapshot) => {
        const game = snapshot.val();
        if (game) {
            showTraineeGame(game, teamId);
        }
    });
}

function showTraineeGame(game, teamId) {
    showScreen('trainee-game');

    document.getElementById('trainee-team-display').textContent = teamName;

    // Afficher score actuel
    database.ref('sessions/' + sessionId + '/teams/' + teamId + '/score').on('value', (snapshot) => {
        const score = snapshot.val() || 0;
        document.getElementById('trainee-score-display').textContent = score + ' pts';
    });

    // Afficher le jeu (sans la question)
    const container = document.getElementById('trainee-game-container');

    if (game.type === 'matching') {
        container.innerHTML = `
            <div class="text-2xl font-bold text-center mb-6 text-gray-800 dark:text-white">
                Faites glisser les √©l√©ments pour les associer
            </div>
            <div class="grid grid-cols-2 gap-6">
                <div class="space-y-3">
                    ${game.pairs.map((pair, i) => `
                        <div class="matching-item bg-gradient-to-r from-blue-500 to-cyan-600 text-white p-4 rounded-xl text-lg font-bold text-center cursor-pointer hover:scale-105 transition-all" data-index="${i}">
                            ${pair.left}
                        </div>
                    `).join('')}
                </div>
                <div class="space-y-3">
                    ${game.pairs.map((pair, i) => `
                        <div class="matching-item bg-gradient-to-r from-purple-500 to-pink-600 text-white p-4 rounded-xl text-lg font-bold text-center cursor-pointer hover:scale-105 transition-all" data-index="${i}">
                            ${pair.right}
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    } else if (game.type === 'sequence') {
        container.innerHTML = `
            <div class="text-2xl font-bold text-center mb-6 text-gray-800 dark:text-white">
                Cliquez pour ordonner les √©tapes
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="sequence-container">
                ${game.items.map((item, i) => `
                    <div class="puzzle-piece text-lg cursor-pointer hover:scale-105 transition-all" onclick="selectSequenceItem(${i})">
                        ${item}
                    </div>
                `).join('')}
            </div>
            <div class="mt-6 p-4 bg-white dark:bg-gray-700 rounded-xl">
                <div class="text-lg font-bold mb-2">Votre ordre :</div>
                <div id="selected-sequence" class="text-gray-600 dark:text-gray-400">Aucune s√©lection</div>
            </div>
        `;
    }

    // Bouton valider
    document.getElementById('trainee-validate-btn').onclick = () => {
        validateTraineeAnswer(teamId);
    };
}

let selectedSequence = [];

window.selectSequenceItem = function(index) {
    if (selectedSequence.includes(index)) {
        selectedSequence = selectedSequence.filter(i => i !== index);
    } else {
        selectedSequence.push(index);
    }

    const game = BOXES[currentBox].games[currentGameIndex];
    const selectedItems = selectedSequence.map(i => game.items[i]);
    document.getElementById('selected-sequence').textContent = selectedItems.join(' ‚Üí ') || 'Aucune s√©lection';
}

function validateTraineeAnswer(teamId) {
    // Marquer comme ayant r√©pondu
    database.ref('sessions/' + sessionId + '/teams/' + teamId + '/hasAnswered').set(true);

    // Afficher √©cran d'attente
    showScreen('trainee-waiting-others');

    // √âcouter pour la correction
    database.ref('sessions/' + sessionId + '/gameStatus').on('value', (snapshot) => {
        if (snapshot.val() === 'correction') {
            showTraineeResult(teamId);
        }
    });
}

function showTraineeResult(teamId) {
    showScreen('trainee-result');

    // Pour simplifier, on affiche toujours une bonne r√©ponse avec 150 pts
    // √Ä d√©velopper : v√©rifier la vraie r√©ponse
    document.getElementById('trainee-result-icon').textContent = '‚úì';
    document.getElementById('trainee-result-title').textContent = 'Bonne r√©ponse !';
    document.getElementById('trainee-result-title').className = 'text-5xl md:text-6xl font-bold mb-6 text-green-600';
    document.getElementById('trainee-points-earned').textContent = '+150';

    // Afficher score total
    database.ref('sessions/' + sessionId + '/teams/' + teamId + '/score').once('value', (snapshot) => {
        const score = snapshot.val() || 0;
        document.getElementById('trainee-total-score').textContent = score + ' pts';
    });

    // Apr√®s 3 secondes, afficher le classement
    setTimeout(() => {
        showScreen('ranking-screen');
        displayRanking('ranking-list');
    }, 3000);
}

// Fonction d'alerte personnalis√©e
function showCustomAlert(message) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
    modal.innerHTML = `
        <div class="glass-morphism p-8 rounded-2xl shadow-2xl max-w-md w-full mx-4 bounce-in">
            <p class="text-gray-700 dark:text-gray-300 mb-6 text-center text-xl font-semibold">${message}</p>
            <button class="w-full px-6 py-4 bg-gradient-to-r from-primary via-purple-600 to-pink-600 text-white rounded-xl font-bold text-lg shadow-lg hover:shadow-2xl transition-all" onclick="this.closest('.fixed').remove()">OK</button>
        </div>
    `;
    document.body.appendChild(modal);
}

function showConfirmDialog(message, onConfirm) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
    modal.innerHTML = `
        <div class="glass-morphism p-8 rounded-2xl shadow-2xl max-w-md w-full mx-4 bounce-in border-2 border-orange-500">
            <p class="text-gray-700 dark:text-gray-300 mb-6 text-center text-xl font-semibold">${message}</p>
            <div class="flex gap-3">
                <button class="flex-1 px-6 py-4 bg-gray-500 hover:bg-gray-600 text-white rounded-xl font-bold text-lg shadow-lg hover:shadow-2xl transition-all" onclick="this.closest('.fixed').remove()">Annuler</button>
                <button id="confirm-btn" class="flex-1 px-6 py-4 bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white rounded-xl font-bold text-lg shadow-lg hover:shadow-2xl transition-all">Confirmer</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);

    modal.querySelector('#confirm-btn').addEventListener('click', () => {
        modal.remove();
        onConfirm();
    });
}

// R√©initialiser
document.getElementById('reset-game-btn').addEventListener('click', () => {
    showConfirmDialog('Voulez-vous vraiment r√©initialiser la session ?', () => {
        database.ref('sessions/' + sessionId).remove();
        location.reload();
    });
});

document.getElementById('restart-game-btn').addEventListener('click', () => {
    database.ref('sessions/' + sessionId).remove();
    location.reload();
});

    </script>
</body>
</html>
