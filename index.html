<!DOCTYPE html>
<html lang="fr" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QCM SST Synchronis√© - Formation Interactive</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap');

        * { font-family: 'Poppins', sans-serif; }

        @keyframes bounce-in {
            0% { transform: scale(0) rotate(-180deg); opacity: 0; }
            50% { transform: scale(1.1) rotate(10deg); }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }

        @keyframes confetti-fall {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(5deg); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 20px rgba(93, 92, 222, 0.5); }
            50% { box-shadow: 0 0 40px rgba(93, 92, 222, 0.8), 0 0 60px rgba(93, 92, 222, 0.6); }
        }

        .bounce-in { animation: bounce-in 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
        .confetti { animation: confetti-fall 3s linear; }
        .float { animation: float 3s ease-in-out infinite; }
        .pulse-anim { animation: pulse 1s ease-in-out infinite; }
        .glow { animation: glow 2s ease-in-out infinite; }

        .glass-morphism {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .dark .glass-morphism {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .neon-text {
            text-shadow: 0 0 10px rgba(93, 92, 222, 0.8), 0 0 20px rgba(93, 92, 222, 0.6), 0 0 30px rgba(93, 92, 222, 0.4);
        }

        .answer-option {
            transition: all 0.3s ease;
            cursor: pointer;
            border: 3px solid transparent;
            user-select: none;
        }

        .answer-option:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }

        .answer-option.selected {
            border-color: #5D5CDE;
            background: linear-gradient(135deg, rgba(93, 92, 222, 0.2) 0%, rgba(93, 92, 222, 0.1) 100%);
            transform: scale(1.05);
        }

        .answer-option.correct {
            border-color: #10b981;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(16, 185, 129, 0.1) 100%);
        }

        .answer-option.incorrect {
            border-color: #ef4444;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2) 0%, rgba(239, 68, 68, 0.1) 100%);
        }

        .sequence-item {
            transition: all 0.3s;
            cursor: pointer;
            border: 3px solid #667eea;
            position: relative;
        }

        .sequence-item:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 12px rgba(102, 126, 234, 0.4);
        }

        .sequence-item.selected {
            border-color: #5D5CDE;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .sequence-item .order-number {
            position: absolute;
            top: -12px;
            left: -12px;
            width: 32px;
            height: 32px;
            background: #5D5CDE;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.1rem;
            border: 3px solid white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }

        .matching-item {
            transition: all 0.3s;
            cursor: pointer;
            border: 3px solid transparent;
        }

        .matching-item:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }

        .matching-item.selected {
            border-color: #FFD700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
            transform: scale(1.08);
        }

        .matching-item.matched {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .box-disabled {
            opacity: 0.5;
            cursor: not-allowed !important;
            filter: grayscale(1);
        }

        .box-disabled:hover {
            transform: none !important;
        }

        .ranking-badge {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }

        .rank-1 { background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); }
        .rank-2 { background: linear-gradient(135deg, #C0C0C0 0%, #808080 100%); }
        .rank-3 { background: linear-gradient(135deg, #CD7F32 0%, #8B4513 100%); }
        .rank-other { background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); }

        body.trainee-connected {
            overflow: hidden !important;
            height: 100vh !important;
            overscroll-behavior: none;
            -webkit-overscroll-behavior: none;
        }

        body.trainee-connected #app {
            overflow-y: auto !important;
            overflow-x: hidden !important;
            height: 100vh !important;
            width: 100% !important;
            -webkit-overflow-scrolling: touch;
        }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                    }
                }
            }
        }
    </script>
</head>
<body class="h-full bg-gradient-to-br from-indigo-100 via-purple-50 to-pink-100 dark:from-gray-900 dark:via-purple-900 dark:to-gray-800">
    <div id="confetti-container" class="fixed inset-0 pointer-events-none z-50"></div>

    <div id="app" class="min-h-screen p-4 md:p-8">

        <!-- √âcran de connexion Superviseur -->
        <div id="supervisor-login" class="max-w-md mx-auto">
            <div class="text-center mb-8 bounce-in">
                <div class="text-8xl mb-6">üë®‚Äçüè´</div>
                <h1 class="text-4xl md:text-5xl font-bold text-primary mb-4">QCM SST Synchronis√©</h1>
                <p class="text-lg text-gray-700 dark:text-gray-300">Formation Interactive</p>
            </div>

            <div class="glass-morphism rounded-3xl shadow-2xl p-8 bounce-in" style="animation-delay: 0.2s">
                <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-6 text-center">Connexion Superviseur</h2>
                <form id="supervisor-login-form" class="space-y-6">
                    <div>
                        <label for="supervisor-password" class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">Mot de passe</label>
                        <input type="password" id="supervisor-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full px-4 py-3 border-2 border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 text-gray-800 dark:text-white text-base focus:border-primary focus:outline-none" required>
                    </div>
                    <div id="login-error" class="hidden text-red-600 dark:text-red-400 text-sm font-semibold text-center bg-red-50 dark:bg-red-900/20 p-3 rounded-lg">‚ùå Mot de passe incorrect</div>
                    <button type="submit" class="w-full bg-gradient-to-r from-primary via-purple-600 to-pink-600 text-white text-xl font-bold py-4 rounded-xl shadow-lg hover:shadow-2xl transform hover:scale-105 transition-all">üîì D√©verrouiller</button>
                </form>
            </div>
        </div>

        <!-- Tableau de bord Superviseur -->
        <div id="supervisor-dashboard" class="hidden max-w-6xl mx-auto">
            <div class="text-center mb-6">
                <h1 class="text-4xl md:text-5xl font-bold text-primary neon-text mb-2">üë®‚Äçüè´ Tableau de Bord Superviseur</h1>
                <p class="text-lg text-gray-600 dark:text-gray-400">Gestion de la session QCM SST</p>
            </div>

            <div class="glass-morphism rounded-3xl shadow-2xl p-8 mb-6 text-center">
                <h3 class="text-2xl font-bold text-gray-800 dark:text-white mb-4">üì± Connexion Stagiaires</h3>
                <p class="text-gray-600 dark:text-gray-400 mb-4">Scannez ce QR code pour rejoindre la session</p>
                <div id="qrcode-container" class="inline-block p-4 bg-white rounded-xl mb-4"></div>
                <p class="text-sm text-gray-500 dark:text-gray-500">Session ID: <span id="session-id-display"></span></p>
            </div>

            <div class="glass-morphism rounded-3xl shadow-2xl p-8 mb-6">
                <h3 class="text-2xl font-bold text-gray-800 dark:text-white mb-4">üë• √âquipes connect√©es (<span id="teams-count">0</span>)</h3>
                <div id="teams-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div class="text-center text-gray-500 dark:text-gray-400">En attente des √©quipes...</div>
                </div>
            </div>

            <div class="flex flex-col md:flex-row gap-4 mb-6">
                <button id="start-game-btn" class="flex-1 bg-gradient-to-r from-green-500 to-emerald-600 text-white text-xl font-bold py-5 rounded-xl shadow-lg hover:shadow-2xl transform hover:scale-105 transition-all">üöÄ Lancer le Jeu</button>
                <button id="reset-game-btn" class="px-8 bg-gradient-to-r from-red-500 to-red-600 text-white text-xl font-bold py-5 rounded-xl shadow-lg hover:shadow-2xl transform hover:scale-105 transition-all">üîÑ R√©initialiser</button>
            </div>
        </div>

        <!-- Connexion Stagiaire -->
        <div id="trainee-login" class="hidden max-w-md mx-auto">
            <div class="text-center mb-8 bounce-in">
                <h1 class="text-5xl md:text-7xl font-bold neon-text text-primary mb-4">üèÜ QCM SST</h1>
                <p class="text-xl md:text-2xl text-gray-700 dark:text-gray-300 font-semibold">Formation Interactive</p>
            </div>
            <div class="glass-morphism rounded-3xl shadow-2xl p-8 text-center bounce-in">
                <div class="text-6xl mb-4">üë•</div>
                <h2 class="text-2xl font-bold text-gray-800 dark:text-white mb-4">Rejoindre la session</h2>
                <p class="text-gray-600 dark:text-gray-400 mb-6">Entrez le nom de votre √©quipe</p>
                <input type="text" id="team-name-input" placeholder="Nom de votre √©quipe" class="w-full px-4 py-3 rounded-lg border-2 border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-gray-800 dark:text-white mb-4 text-base focus:border-primary focus:outline-none" maxlength="20">
                <button id="join-game-btn" class="w-full bg-gradient-to-r from-primary via-purple-600 to-pink-600 text-white text-xl font-bold py-4 rounded-xl shadow-lg hover:shadow-2xl transform hover:scale-105 transition-all">üöÄ Rejoindre</button>
            </div>
        </div>

        <!-- Attente Stagiaire -->
        <div id="trainee-waiting" class="hidden max-w-5xl mx-auto text-center">
            <div class="glass-morphism rounded-3xl shadow-2xl p-12 bounce-in">
                <div class="text-8xl mb-6">‚è≥</div>
                <h1 class="text-5xl md:text-6xl font-bold text-primary neon-text mb-6">En attente...</h1>
                <p class="text-2xl text-gray-700 dark:text-gray-300 mb-8">Le superviseur va lancer le jeu</p>
                <div class="bg-gradient-to-r from-primary via-purple-600 to-pink-600 text-white rounded-2xl p-8 shadow-2xl">
                    <div class="text-5xl font-bold mb-3" id="trainee-team-name-display"></div>
                    <div class="text-xl">Vous √™tes connect√© !</div>
                </div>
                <div class="mt-8 flex items-center justify-center space-x-2">
                    <div class="w-3 h-3 bg-primary rounded-full animate-bounce" style="animation-delay: 0s"></div>
                    <div class="w-3 h-3 bg-primary rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                    <div class="w-3 h-3 bg-primary rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
                </div>
            </div>
        </div>

        <!-- √âcran Coffres -->
        <div id="boxes-screen" class="hidden max-w-7xl mx-auto">
            <div class="text-center mb-6">
                <h1 class="text-4xl md:text-5xl font-bold text-primary neon-text mb-4">üéÅ Les Coffres au Tr√©sor SST</h1>
                <div class="text-xl text-gray-700 dark:text-gray-300">Cliquez sur un coffre pour lancer les questions</div>
            </div>
            <div id="boxes-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8 mb-8"></div>
        </div>

        <!-- Projecteur Question -->
        <div id="projector-question" class="hidden max-w-7xl mx-auto">
            <div class="glass-morphism rounded-3xl shadow-2xl p-8 mb-6">
                <div class="text-center mb-6">
                    <div class="text-6xl mb-4" id="projector-game-icon">üéØ</div>
                    <h2 class="text-3xl md:text-4xl font-bold text-primary mb-4" id="projector-question-text">Question...</h2>
                </div>
                <div id="projector-game-container" class="mb-6"></div>

                <!-- Timer 30 secondes -->
                <div class="text-center mb-6">
                    <div class="inline-block bg-gradient-to-r from-red-500 to-orange-500 text-white px-12 py-6 rounded-2xl shadow-2xl">
                        <div class="text-6xl font-bold" id="timer-display">30</div>
                        <div class="text-xl font-semibold mt-2">secondes</div>
                    </div>
                </div>

                <div class="text-center">
                    <div class="inline-block bg-white dark:bg-gray-800 px-8 py-4 rounded-2xl shadow-lg">
                        <div class="text-2xl font-bold text-primary"><span id="answered-count">0</span> / <span id="total-teams-count">0</span> √©quipes ont r√©pondu</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Projecteur Correction -->
        <div id="projector-correction" class="hidden max-w-7xl mx-auto">
            <div class="glass-morphism rounded-3xl shadow-2xl p-8 mb-6 text-center">
                <div class="text-8xl mb-6">‚úÖ</div>
                <h2 class="text-4xl md:text-5xl font-bold text-green-600 mb-6">CORRECTION</h2>
                <div id="projector-correction-content" class="mb-8"></div>
                <div class="bg-blue-50 dark:bg-blue-900 rounded-2xl p-6 mb-6">
                    <div class="text-2xl font-bold text-gray-800 dark:text-white mb-2">üí° Explication</div>
                    <p class="text-lg text-gray-700 dark:text-gray-300" id="projector-explanation">...</p>
                </div>
                <button id="next-question-btn" class="bg-gradient-to-r from-green-500 to-emerald-600 text-white text-2xl font-bold py-5 px-12 rounded-xl shadow-lg hover:shadow-2xl transform hover:scale-105 transition-all">Question Suivante ‚Üí</button>
            </div>
        </div>

        <!-- Stagiaire Jeu -->
        <div id="trainee-game" class="hidden max-w-6xl mx-auto">
            <div class="glass-morphism rounded-2xl shadow-xl p-6 mb-6">
                <div class="flex justify-between items-center">
                    <div class="text-2xl font-bold text-primary" id="trainee-team-display"></div>
                    <div class="text-3xl font-bold text-green-600" id="trainee-score-display">0 pts</div>
                </div>
            </div>
            <div id="trainee-game-container" class="glass-morphism rounded-3xl shadow-2xl p-8 mb-6"></div>
            <button id="trainee-validate-btn" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white text-2xl font-bold py-5 rounded-xl shadow-lg hover:shadow-2xl transform hover:scale-105 transition-all">‚úì Valider ma r√©ponse</button>
        </div>

        <!-- Stagiaire Attente autres -->
        <div id="trainee-waiting-others" class="hidden max-w-5xl mx-auto text-center">
            <div class="glass-morphism rounded-3xl shadow-2xl p-12 bounce-in">
                <div class="text-8xl mb-6">‚è≥</div>
                <h1 class="text-5xl md:text-6xl font-bold text-primary neon-text mb-6">R√©ponse enregistr√©e !</h1>
                <p class="text-2xl text-gray-700 dark:text-gray-300 mb-8">En attente des autres √©quipes...</p>
                <div class="mt-8 flex items-center justify-center space-x-2">
                    <div class="w-3 h-3 bg-primary rounded-full animate-bounce" style="animation-delay: 0s"></div>
                    <div class="w-3 h-3 bg-primary rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                    <div class="w-3 h-3 bg-primary rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
                </div>
            </div>
        </div>

        <!-- Stagiaire R√©sultat -->
        <div id="trainee-result" class="hidden max-w-5xl mx-auto text-center">
            <div class="glass-morphism rounded-3xl shadow-2xl p-12 bounce-in">
                <div class="text-8xl mb-6" id="trainee-result-icon">‚úì</div>
                <h1 class="text-5xl md:text-6xl font-bold mb-6" id="trainee-result-title">Bonne r√©ponse !</h1>
                <div class="bg-gradient-to-r from-primary via-purple-600 to-pink-600 text-white rounded-2xl p-10 mb-8 shadow-2xl">
                    <div class="text-7xl font-bold mb-3" id="trainee-points-earned">+150</div>
                    <div class="text-3xl font-semibold">Points gagn√©s</div>
                </div>
                <div class="bg-white dark:bg-gray-800 rounded-2xl p-6">
                    <div class="text-4xl font-bold text-primary mb-2" id="trainee-total-score">150</div>
                    <div class="text-xl text-gray-600 dark:text-gray-400">Score total</div>
                </div>
            </div>
        </div>

        <!-- Classement -->
        <div id="ranking-screen" class="hidden max-w-7xl mx-auto">
            <div class="glass-morphism rounded-3xl shadow-2xl p-8 text-center">
                <h2 class="text-4xl md:text-5xl font-bold text-primary neon-text mb-8">üèÜ CLASSEMENT</h2>
                <div id="ranking-list" class="space-y-4 mb-8"></div>
                <div class="text-center text-gray-600 dark:text-gray-400">En attente de la prochaine question...</div>
            </div>
        </div>

        <!-- Pause entre Coffres -->
        <div id="pause-screen" class="hidden max-w-5xl mx-auto text-center">
            <div class="glass-morphism rounded-3xl shadow-2xl p-12 bounce-in">
                <div class="text-8xl mb-6">‚è∏Ô∏è</div>
                <h1 class="text-5xl md:text-6xl font-bold text-primary neon-text mb-6">Pause - Coffre <span id="pause-box-number">1</span> termin√© !</h1>
                <p class="text-2xl text-gray-700 dark:text-gray-300 mb-8">Atelier pratique en cours...</p>
                <div class="bg-gradient-to-r from-primary via-purple-600 to-pink-600 text-white rounded-2xl p-10 mb-8 shadow-2xl">
                    <div class="text-5xl font-bold mb-3">Classement actuel</div>
                </div>
                <div id="pause-ranking" class="bg-white dark:bg-gray-800 rounded-2xl p-6 mb-8"></div>
                <button id="next-box-btn" class="bg-gradient-to-r from-green-500 to-emerald-600 text-white text-2xl font-bold py-5 px-12 rounded-xl shadow-lg hover:shadow-2xl transform hover:scale-105 transition-all">‚ñ∂Ô∏è Lancer Coffre <span id="next-box-number">2</span></button>
            </div>
        </div>

        <!-- Podium Final -->
        <div id="podium-screen" class="hidden max-w-7xl mx-auto text-center">
            <div class="glass-morphism rounded-3xl shadow-2xl p-12 bounce-in">
                <div class="text-8xl mb-6">üèÜ</div>
                <h1 class="text-5xl md:text-6xl font-bold text-primary neon-text mb-8">MISSION ACCOMPLIE !</h1>
                <div class="flex justify-center items-end gap-8 mb-12">
                    <div id="podium-container" class="flex justify-center items-end gap-4"></div>
                </div>
                <div id="full-ranking" class="bg-white dark:bg-gray-800 rounded-2xl p-8">
                    <h3 class="text-2xl font-bold mb-4">Classement Final</h3>
                    <div id="full-ranking-list"></div>
                </div>
                <button id="restart-game-btn" class="mt-8 bg-gradient-to-r from-primary via-purple-600 to-pink-600 text-white text-xl font-bold py-4 px-12 rounded-xl shadow-lg hover:shadow-2xl transform hover:scale-105 transition-all">üîÑ Nouvelle Session</button>
            </div>
        </div>

    </div>

    <script>
        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAZLBDZIaPp3GrXuVz4fPiK91JhLEqXPs0",
            authDomain: "jeu-sst-v1-291025.firebaseapp.com",
            databaseURL: "https://jeu-sst-v1-291025-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "jeu-sst-v1-291025",
            storageBucket: "jeu-sst-v1-291025.firebasestorage.app",
            messagingSenderId: "57462613537",
            appId: "1:57462613537:web:6178195b2f4f08fbaa2560"
        };

        // Variables globales
        let database = null;
        let sessionId = null;
        let userRole = null;
        let teamName = null;
        let teamId = null;
        let currentBox = 0;
        let currentGameIndex = 0;
        let selectedAnswer = null;
        let selectedSequence = [];
        let selectedMatching = [];
        let openedBoxes = [];
        let answersListener = null;
        let allActiveListeners = [];
        let timerInterval = null;
        let timeRemaining = 30;
        let gameStatusListener = null;
        let currentGameListener = null;

        const SUPERVISOR_PASSWORD = "sst2025";
        const QUESTION_TIME_LIMIT = 30;

        // Sauvegarder la session en mettant √† jour l'URL
        function saveTraineeSessionToURL() {
            if (userRole === 'trainee' && teamId && sessionId) {
                const url = new URL(window.location.href);
                url.searchParams.set('session', sessionId);
                url.searchParams.set('team', teamId);
                window.history.replaceState({}, '', url.toString());
                console.log('üíæ Session sauvegard√©e dans URL:', { sessionId, teamId });
            }
        }

        // V√©rifier si une √©quipe existe dans Firebase
        function checkTeamExists(sessionId, teamId) {
            return database.ref('sessions/' + sessionId + '/teams/' + teamId).once('value').then(snapshot => {
                return snapshot.exists() ? snapshot.val() : null;
            });
        }

        // Reconnecter √† une session existante
        function reconnectToSession(sessionId, teamId, teamData) {
            console.log('üîÑ Reconnexion √† la session:', { sessionId, teamId, teamName: teamData.name });

            userRole = 'trainee';
            teamName = teamData.name;

            enableTraineeScrollProtection();

            const teamRef = database.ref('sessions/' + sessionId + '/teams/' + teamId);
            teamRef.onDisconnect().remove();
            console.log('üîå Listener de d√©connexion r√©activ√© pour:', teamName);

            database.ref('sessions/' + sessionId + '/status').once('value', (snapshot) => {
                const status = snapshot.val();

                if (!status) {
                    showCustomAlert('Cette session n\'existe plus. Veuillez rejoindre une nouvelle session.');
                    clearSessionFromURL();
                    disableTraineeScrollProtection();
                    showScreenSafe('trainee-login');
                    return;
                }

                if (status === 'waiting') {
                    showScreenSafe('trainee-waiting');
                    document.getElementById('trainee-team-name-display').textContent = teamName;

                    database.ref('sessions/' + sessionId + '/status').on('value', (snapshot) => {
                        const newStatus = snapshot.val();
                        if (newStatus === 'playing') {
                            listenForGameUpdatesTrainee();
                        }
                    });
                } else if (status === 'playing') {
                    listenForGameUpdatesTrainee();
                }
            });
        }

        // Effacer la session de l'URL
        function clearSessionFromURL() {
            const url = new URL(window.location.href);
            url.searchParams.delete('team');
            window.history.replaceState({}, '', url.toString());
            console.log('üóëÔ∏è Session effac√©e de l\'URL');
        }

        // Activation protection scroll
        function enableTraineeScrollProtection() {
            document.body.classList.add('trainee-connected');
            console.log('üîí Protection scroll activ√©e');
        }

        // D√©sactivation protection scroll
        function disableTraineeScrollProtection() {
            document.body.classList.remove('trainee-connected');
            console.log('üîì Protection scroll d√©sactiv√©e');
        }

        // Nettoyer TOUS les listeners Firebase actifs
        function cleanupAllFirebaseListeners() {
            console.log('üßπ Nettoyage complet de tous les listeners Firebase...');
            
            // Arr√™ter le timer
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            // Arr√™ter les listeners de gameStatus
            if (gameStatusListener) {
                database.ref('sessions/' + sessionId + '/gameStatus').off('value', gameStatusListener);
                gameStatusListener = null;
            }
            
            // Arr√™ter les listeners de currentGame
            if (currentGameListener) {
                database.ref('sessions/' + sessionId + '/currentGame').off('value', currentGameListener);
                currentGameListener = null;
            }
            
            // Arr√™ter le listener de answersCount
            if (answersListener) {
                database.ref('sessions/' + sessionId + '/answersCount').off('value', answersListener);
                answersListener = null;
            }
            
            // Arr√™ter tous les autres listeners
            allActiveListeners.forEach(listener => {
                try {
                    listener.off();
                } catch(e) {
                    console.log('Erreur lors du nettoyage:', e);
                }
            });
            allActiveListeners = [];
            
            console.log('‚úÖ Tous les listeners nettoy√©s');
        }

        // Afficher un √©cran ET nettoyer les anciens listeners
        function showScreenSafe(screenId) {
            console.log('üì∫ Affichage de l\'√©cran:', screenId);
            
            // Nettoyer les listeners AVANT de changer d'√©cran
            cleanupAllFirebaseListeners();
            
            // Cacher tous les √©crans
            document.querySelectorAll('#app > div').forEach(screen => {
                screen.classList.add('hidden');
            });
            
            // Afficher le nouvel √©cran
            document.getElementById(screenId).classList.remove('hidden');
            
            // Scroll vers le haut de l'√©cran
            document.getElementById('app').scrollTop = 0;
        }

        // D√©marrer le timer de 30 secondes
        function startQuestionTimer() {
            timeRemaining = QUESTION_TIME_LIMIT;
            document.getElementById('timer-display').textContent = timeRemaining;
            document.getElementById('timer-display').style.color = 'white';

            timerInterval = setInterval(() => {
                timeRemaining--;
                document.getElementById('timer-display').textContent = timeRemaining;

                if (timeRemaining <= 5) {
                    document.getElementById('timer-display').style.color = '#FF0000';
                    document.getElementById('timer-display').classList.add('pulse-anim');
                } else if (timeRemaining <= 10) {
                    document.getElementById('timer-display').style.color = '#FFA500';
                }

                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                    handleTimeUp();
                }
            }, 1000);
        }

        // Quand le temps est √©coul√©
        function handleTimeUp() {
            console.log('‚è∞ TIMEOUT - Temps √©coul√©!');
            playHornSound();

            database.ref('sessions/' + sessionId + '/teams').once('value', (snapshot) => {
                const teams = snapshot.val();
                if (!teams) return;

                const updates = {};
                let nonRespondantsCount = 0;
                const totalTeams = Object.keys(teams).length;

                Object.entries(teams).forEach(([id, team]) => {
                    if (!team.hasAnswered) {
                        console.log('‚è∞ √âquipe', team.name, 'n\'a pas r√©pondu');
                        updates['sessions/' + sessionId + '/teams/' + id + '/hasAnswered'] = true;
                        updates['sessions/' + sessionId + '/teams/' + id + '/answer'] = null;
                        updates['sessions/' + sessionId + '/teams/' + id + '/isCorrect'] = false;
                        updates['sessions/' + sessionId + '/teams/' + id + '/lastPoints'] = 0;
                        nonRespondantsCount++;
                    }
                });

                console.log('üìä Non-r√©pondants:', nonRespondantsCount, '/', totalTeams);

                if (Object.keys(updates).length > 0) {
                    database.ref().update(updates).then(() => {
                        const countRef = database.ref('sessions/' + sessionId + '/answersCount');
                        return countRef.transaction((currentCount) => {
                            return (currentCount || 0) + nonRespondantsCount;
                        });
                    }).then(() => {
                        console.log('‚úÖ Marquage des non-r√©pondants TERMIN√â');
                        showCorrection();
                    });
                } else {
                    console.log('‚úÖ Tout le monde avait d√©j√† r√©pondu');
                    showCorrection();
                }
            });
        }

        // V√©rifier si toutes les √©quipes ont r√©pondu
        function checkIfAllAnswered() {
            database.ref('sessions/' + sessionId + '/teams').once('value', (teamsSnapshot) => {
                const teams = teamsSnapshot.val();
                if (!teams) return;

                const totalTeams = Object.keys(teams).length;

                database.ref('sessions/' + sessionId + '/answersCount').once('value', (countSnapshot) => {
                    const count = countSnapshot.val() || 0;
                    console.log('üîç V√©rification r√©ponses:', count, '/', totalTeams);

                    if (count >= totalTeams && totalTeams > 0) {
                        console.log('‚úÖ Tous ont r√©pondu apr√®s timeout - passage correction');
                        if (answersListener) {
                            database.ref('sessions/' + sessionId + '/answersCount').off('value', answersListener);
                            answersListener = null;
                        }
                        setTimeout(() => showCorrection(), 1000);
                    }
                });
            });
        }

        // Jouer le son de klaxon
        function playHornSound() {
            const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hZFQlMouLvuWgiCTGH0fPTgjMGHm7A7+OZUQ0PVKzn77NgGAg+ltry0XwpBSp+zO/ajEIJE2C18NBuJAIygdLy0n0qBSp+zO/bfSkFKoLS8tJ9KgUqftLv2n0pBSqC0vLSfSkFKoLS8tJ9KgUqftLv2X0pBSqC0vLSfSkFKoLS8tJ9KgUqftLv2n0pBSqB0vLSfSkFKoLS8tJ9KgUqftLv2X0pBSqC0vLSfSkFKoLS8tJ9KgUqftLv2n0pBSqC0vLSfSkFKoLS8tJ9KgUqftLv2X0pBSqC0vLSfSkFKoLS8tJ9KgUqftLv2n0pBSqC0vLSfSkFKoLS8tJ9KgUqftLv2X0qBSqC0vLSfSkFKoLS8tJ9KgUqftLv2n0pBSqC0vLSfSkFKoLS8tJ9KgUqftLv2X0pBSqC0vLSfSkFKoLS8tJ9KgUqftLv2n0pBSqC0vLSfSkFKoLS8tJ9KgUqftLv2X0pBSqC0vLSfSkFKoLS8tJ9KgUqftLv2n0pBSqC0vLSfSkFKoLS8tJ9KgUqftLv');
            audio.play().catch(e => console.log('Son non jou√©:', e));
        }

        // Initialiser Firebase
        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            console.log('‚úÖ Firebase initialis√©');
        } catch (error) {
            console.error('‚ùå Erreur Firebase:', error);
        }

        // G√©n√©rer UUID unique
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // Base de donn√©es des questions SST
        const BOXES_DATA = [
            {
                title: 'DC4 - Pr√©vention',
                subtitle: 'Situations sp√©cifiques et pr√©vention',
                icon: 'üè•',
                color: 'from-purple-500 to-pink-600',
                games: [
                    { type: 'quiz', title: 'R√¥le de pr√©vention', question: 'En plus des secours, quel est l\'autre r√¥le majeur du SST ?', options: ['Nettoyer les lieux', 'Participer √† la pr√©vention des risques', 'Former les autres', 'G√©rer la trousse'], correctAnswer: 1, explanation: 'Le SST participe activement √† la pr√©vention des risques professionnels dans son entreprise.' },
                    { type: 'quiz', title: 'DAE', question: 'Le SST peut-il utiliser un d√©fibrillateur automatis√© externe (DAE) ?', options: ['Non, formation sp√©cifique requise', 'Oui, tout citoyen peut l\'utiliser', 'Seulement les pompiers', 'Sur prescription uniquement'], correctAnswer: 1, explanation: 'Tout citoyen, y compris les SST, peut utiliser un DAE. L\'appareil guide l\'utilisateur.' },
                    { type: 'true-false', title: 'Recyclage', question: 'Le certificat SST doit √™tre recycl√© tous les 2 ans.', options: ['Vrai', 'Faux'], correctAnswer: 0, explanation: 'VRAI - Le recyclage SST doit avoir lieu tous les 24 mois pour maintenir la validit√© du certificat.' },
                    { type: 'matching', title: 'Acteurs de pr√©vention', question: 'Associez chaque acteur √† son r√¥le :', pairs: [{ left: 'SST', right: 'Premiers secours et pr√©vention' }, { left: 'M√©decin du travail', right: 'Sant√© des salari√©s' }, { left: 'CHSCT/CSE', right: 'Repr√©sentation du personnel' }, { left: 'Employeur', right: 'Responsable s√©curit√©' }], explanation: 'Chaque acteur a un r√¥le compl√©mentaire dans la pr√©vention des risques professionnels.' },
                    { type: 'sequence', title: 'D√©marche de pr√©vention', question: 'Remettez dans l\'ordre les √©tapes de la d√©marche de pr√©vention :', items: ['Rep√©rer le danger', 'Analyser les risques', 'Proposer des solutions', 'Informer et suivre'], correctOrder: [0, 1, 2, 3], explanation: 'La d√©marche de pr√©vention suit une logique rigoureuse pour r√©duire efficacement les risques.' },
                    { type: 'quiz', title: 'Document unique', question: 'Le Document Unique d\'√âvaluation des Risques (DUER) doit √™tre mis √† jour :', options: ['Tous les ans obligatoirement', 'En cas de modification importante ou nouvel √©quipement', 'Seulement en cas d\'accident grave', 'Tous les 5 ans'], correctAnswer: 1, explanation: 'Le DUER doit √™tre mis √† jour d√®s qu\'il y a une modification significative dans l\'entreprise.' },
                    { type: 'quiz', title: 'Signalisation', question: 'Qu\'indique un pictogramme jaune et noir sur la signalisation ?', options: ['Danger imm√©diat', 'Zone interdite', 'Avertissement de danger', 'Obligation'], correctAnswer: 2, explanation: 'Le jaune et noir est utilis√© pour avertir d\'un danger potentiel en mati√®re de s√©curit√©.' }
                ]
            },
            {
                title: 'DC1 - Prot√©ger',
                subtitle: 'Situer son r√¥le et prot√©ger',
                icon: 'üõ°Ô∏è',
                color: 'from-blue-500 to-blue-700',
                games: [
                    { type: 'quiz', title: 'Cadre juridique', question: 'Quel est le cadre juridique qui d√©finit le r√¥le du SST ?', options: ['Code du Travail (Article R4224-15)', 'Code Civil', 'Code de la Sant√© Publique', 'R√®glement Int√©rieur'], correctAnswer: 0, explanation: 'Le Code du Travail, article R4224-15, d√©finit le r√¥le et les obligations du Sauveteur Secouriste du Travail.' },
                    { type: 'quiz', title: 'R√¥le du SST', question: 'Quel est le r√¥le principal d\'un SST ?', options: ['Remplacer les services d\'urgence', 'Porter les premiers secours et pr√©venir les risques', 'Soigner toutes les blessures', 'Evacuer les victimes'], correctAnswer: 1, explanation: 'Le SST a un double r√¥le : porter secours en cas d\'accident ET participer √† la pr√©vention.' },
                    { type: 'quiz', title: 'Formation SST', question: 'Quelle est la dur√©e de validit√© d\'un certificat SST ?', options: ['1 an', '2 ans', '3 ans', '5 ans'], correctAnswer: 1, explanation: 'Le certificat SST est valable 24 mois et doit √™tre recycl√© r√©guli√®rement.' },
                    { type: 'true-false', title: 'M√©dicaments', question: 'Un SST peut administrer des m√©dicaments √† une victime.', options: ['Vrai', 'Faux'], correctAnswer: 1, explanation: 'FAUX - Un SST ne peut jamais administrer de m√©dicaments. C\'est un acte m√©dical r√©serv√© aux professionnels de sant√©.' },
                    { type: 'sequence', title: 'Cha√Æne de secours', question: 'Remettez dans l\'ordre les √©tapes de la cha√Æne de secours :', items: ['Prot√©ger', 'Examiner', 'Faire alerter / Alerter', 'Secourir'], correctOrder: [0, 1, 2, 3], explanation: 'La cha√Æne de secours suit toujours cet ordre : Prot√©ger, Examiner, Faire Alerter/Alerter, puis Secourir.' },
                    { type: 'matching', title: 'Champ d\'intervention', question: 'Associez chaque action avec le bon intervenant :', pairs: [{ left: 'Porter les premiers secours', right: 'SST' }, { left: 'Prescrire un traitement', right: 'M√©decin' }, { left: 'Prot√©ger et alerter', right: 'SST' }, { left: 'Transport m√©dicalis√©', right: 'Secours sp√©cialis√©s' }], explanation: 'Chaque intervenant a un r√¥le sp√©cifique. Le SST ne peut pas prescrire de traitement ni faire de transport m√©dicalis√©.' },
                    { type: 'true-false', title: 'Pr√©vention au quotidien', question: 'Un SST doit participer activement √† la pr√©vention des risques dans son entreprise.', options: ['Vrai', 'Faux'], correctAnswer: 0, explanation: 'VRAI - Le SST a un double r√¥le : porter secours en cas d\'accident ET contribuer √† la pr√©vention des risques professionnels au quotidien.' }
                ]
            },
            {
                title: 'DC2 - Examiner',
                subtitle: 'Examiner la victime',
                icon: 'üîç',
                color: 'from-green-500 to-green-700',
                games: [
                    { type: 'quiz', title: 'Conscience', question: 'Comment v√©rifier la conscience d\'une victime ?', options: ['Lui poser une question et secouer les √©paules', 'La gifler', 'Lui verser de l\'eau', 'Attendre qu\'elle se r√©veille'], correctAnswer: 0, explanation: 'On v√©rifie la conscience en posant une question simple et en secouant doucement les √©paules de la victime.' },
                    { type: 'quiz', title: 'H√©morragie', question: 'Qu\'est-ce qu\'une h√©morragie externe ?', options: ['Un saignement visible qui ne s\'arr√™te pas', 'Un h√©matome', 'Une √©gratignure', 'Un saignement de nez'], correctAnswer: 0, explanation: 'Une h√©morragie externe est un saignement abondant et visible qui ne s\'arr√™te pas spontan√©ment.' },
                    { type: 'true-false', title: 'Respiration et pouls', question: 'Pour v√©rifier la respiration, il suffit de prendre le pouls.', options: ['Vrai', 'Faux'], correctAnswer: 1, explanation: 'FAUX - La prise de pouls n\'est pas fiable. Il faut utiliser la m√©thode VES (Voir, √âcouter, Sentir) pendant 10 secondes.' },
                    { type: 'sequence', title: 'Ordre d\'examen', question: 'Dans quel ordre examinez-vous une victime ?', items: ['V√©rifier la conscience', 'V√©rifier la respiration', 'Rechercher une h√©morragie', 'Rechercher d\'autres signes'], correctOrder: [0, 1, 2, 3], explanation: 'L\'examen suit toujours cet ordre de priorit√© pour d√©tecter les d√©tresses vitales.' },
                    { type: 'matching', title: 'Signes et sympt√¥mes', question: 'Associez chaque signe avec sa cat√©gorie :', pairs: [{ left: 'Ne r√©pond pas', right: 'Inconscience' }, { left: 'Ventre qui se soul√®ve', right: 'Respiration' }, { left: 'Saignement abondant', right: 'H√©morragie' }, { left: 'Br√ªlure, plaie', right: 'Autres signes' }], explanation: 'Chaque signe permet d\'identifier une d√©tresse sp√©cifique n√©cessitant une action appropri√©e.' },
                    { type: 'quiz', title: 'Position d\'attente', question: 'Une victime consciente qui a vomi doit √™tre plac√©e en quelle position ?', options: ['Sur le dos', 'En position lat√©rale de s√©curit√© (PLS)', 'Assise', 'Debout'], correctAnswer: 1, explanation: 'La PLS √©vite que la victime ne s\'√©touffe avec ses vomissements ou sa langue.' },
                    { type: 'true-false', title: 'Temp√©rature', question: 'On doit v√©rifier la temp√©rature corporelle d\'une victime ayant subi un choc.', options: ['Vrai', 'Faux'], correctAnswer: 1, explanation: 'FAUX - Ce n\'est pas une priorit√©. On se concentre sur la conscience, la respiration et les h√©morragies.' }
                ]
            },
            {
                title: 'DC3 - Alerter & Secourir',
                subtitle: 'Faire alerter et secourir',
                icon: 'ü©π',
                color: 'from-red-500 to-orange-600',
                games: [
                    { type: 'quiz', title: 'Num√©ros d\'urgence', question: 'Quel num√©ro appeler pour un accident du travail avec victime grave ?', options: ['15 - SAMU', '17 - Police', '18 - Pompiers', '112 - Num√©ro europ√©en'], correctAnswer: 0, explanation: 'Le 15 (SAMU) est le num√©ro √† appeler pour toute urgence m√©dicale.' },
                    { type: 'quiz', title: 'Arr√™t cardiaque', question: 'Si vous √™tes seul avec une victime en arr√™t cardiaque, que faites-vous ?', options: ['Rester sans alerter', 'Alerter AVANT de r√©animer', 'Attendre de l\'aide', 'Chercher un d√©fibrillateur'], correctAnswer: 1, explanation: 'Il faut toujours alerter les secours avant de commencer la r√©animation si on est seul.' },
                    { type: 'true-false', title: 'Num√©ro 112', question: 'Le num√©ro 112 fonctionne dans tous les pays de l\'UE.', options: ['Vrai', 'Faux'], correctAnswer: 0, explanation: 'VRAI - Le 112 est le num√©ro d\'urgence europ√©en unique. Il est gratuit et accessible partout dans l\'UE.' },
                    { type: 'matching', title: 'Num√©ros d\'urgence', question: 'Associez chaque num√©ro √† son service :', pairs: [{ left: '15', right: 'SAMU' }, { left: '18', right: 'Pompiers' }, { left: '112', right: 'Num√©ro europ√©en' }, { left: '114', right: 'Sourds et malentendants' }], explanation: 'Conna√Ætre les num√©ros d\'urgence permet de contacter rapidement le bon service.' },
                    { type: 'sequence', title: 'Contenu de l\'alerte', question: 'Ordre des informations √† donner aux secours :', items: ['Lieu exact et acc√®s', 'Nature de l\'accident', 'Nombre et √©tat des victimes', 'Gestes d√©j√† effectu√©s'], correctOrder: [0, 1, 2, 3], explanation: 'Suivre cet ordre permet de transmettre efficacement toutes les informations n√©cessaires aux secours.' },
                    { type: 'quiz', title: 'RCP', question: 'Lors d\'une RCP, quel est le ratio compressions/insufflations ?', options: ['15 compressions pour 2 insufflations', '30 compressions pour 2 insufflations', '10 compressions pour 1 insufflation', '5 compressions pour 1 insufflation'], correctAnswer: 1, explanation: 'Le ratio recommand√© est de 30 compressions thoraciques pour 2 insufflations.' },
                    { type: 'true-false', title: 'D√©fibrillateur', question: 'Le d√©fibrillateur automatis√© externe (DAE) peut √™tre utilis√© par toute personne, m√™me sans formation.', options: ['Vrai', 'Faux'], correctAnswer: 0, explanation: 'VRAI - Selon la loi, toute personne peut utiliser un DAE. L\'appareil donne des instructions vocales et ne d√©livrera un choc que si n√©cessaire.' }
                ]
            }
        ];

        // Fonctions utilitaires
        function showScreen(screenId) {
            document.querySelectorAll('#app > div').forEach(screen => screen.classList.add('hidden'));
            document.getElementById(screenId).classList.remove('hidden');
        }

        function createConfetti() {
            const colors = ['#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A'];
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.position = 'fixed';
                confetti.style.width = '10px';
                confetti.style.height = '10px';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.left = Math.random() * window.innerWidth + 'px';
                confetti.style.top = '-10px';
                confetti.style.zIndex = '9999';
                document.getElementById('confetti-container').appendChild(confetti);
                setTimeout(() => confetti.remove(), 3000);
            }
        }

        function getTeamEmoji(index) {
            const emojis = ['üöí', 'üöë', '‚ö°', 'üõ°Ô∏è', 'üî•', 'üí™', 'üéØ', '‚≠ê', 'üèÜ', 'üöÄ'];
            const numIndex = typeof index === 'string' ? parseInt(index.split('-').pop() || '0') : index;
            return emojis[numIndex % emojis.length];
        }

        function showCustomAlert(message) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="glass-morphism p-8 rounded-2xl shadow-2xl max-w-md w-full mx-4 bounce-in">
                    <p class="text-gray-700 dark:text-gray-300 mb-6 text-center text-xl font-semibold">${message}</p>
                    <button class="w-full px-6 py-4 bg-gradient-to-r from-primary via-purple-600 to-pink-600 text-white rounded-xl font-bold text-lg shadow-lg hover:shadow-2xl transition-all" onclick="this.closest('.fixed').remove()">OK</button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function showConfirmDialog(message, onConfirm) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="glass-morphism p-8 rounded-2xl shadow-2xl max-w-md w-full mx-4 bounce-in border-2 border-orange-500">
                    <p class="text-gray-700 dark:text-gray-300 mb-6 text-center text-xl font-semibold">${message}</p>
                    <div class="flex gap-3">
                        <button class="flex-1 px-6 py-4 bg-gray-500 hover:bg-gray-600 text-white rounded-xl font-bold text-lg shadow-lg hover:shadow-2xl transition-all" onclick="this.closest('.fixed').remove()">Annuler</button>
                        <button id="confirm-btn" class="flex-1 px-6 py-4 bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white rounded-xl font-bold text-lg shadow-lg hover:shadow-2xl transition-all">Confirmer</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.querySelector('#confirm-btn').addEventListener('click', () => {
                modal.remove();
                onConfirm();
            });
        }

        // Randomiser les questions d'un coffre
        function getRandomizedGames(boxIndex) {
            const allGames = [...BOXES_DATA[boxIndex].games];
            for (let i = allGames.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [allGames[i], allGames[j]] = [allGames[j], allGames[i]];
            }
            return allGames.slice(0, 7);
        }

        // Pr√©parer le jeu avec r√©ponses m√©lang√©es
        function prepareGameWithShuffledAnswers(game) {
            let shuffledGame = { ...game };

            if (game.type === 'quiz' || game.type === 'true-false') {
                const optionsWithIndex = game.options.map((opt, i) => ({ 
                    text: opt, 
                    originalIndex: i 
                }));
                
                for (let i = optionsWithIndex.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [optionsWithIndex[i], optionsWithIndex[j]] = 
                        [optionsWithIndex[j], optionsWithIndex[i]];
                }
                
                shuffledGame.optionsWithIndex = optionsWithIndex;
                shuffledGame.options = optionsWithIndex.map(o => o.text);
            }
            
            else if (game.type === 'sequence') {
                const itemsWithIndex = game.items.map((item, i) => ({
                    text: item,
                    originalIndex: i
                }));
                
                for (let i = itemsWithIndex.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [itemsWithIndex[i], itemsWithIndex[j]] = 
                        [itemsWithIndex[j], itemsWithIndex[i]];
                }
                
                shuffledGame.itemsWithIndex = itemsWithIndex;
                shuffledGame.items = itemsWithIndex.map(i => i.text);
            }
            
            else if (game.type === 'matching') {
                const pairsLeft = game.pairs.map((p, i) => ({
                    text: p.left,
                    originalIndex: i,
                    side: 'left'
                }));
                
                const pairsRight = game.pairs.map((p, i) => ({
                    text: p.right,
                    originalIndex: i,
                    side: 'right'
                }));
                
                for (let i = pairsLeft.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [pairsLeft[i], pairsLeft[j]] = [pairsLeft[j], pairsLeft[i]];
                }
                
                for (let i = pairsRight.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [pairsRight[i], pairsRight[j]] = [pairsRight[j], pairsRight[i]];
                }
                
                shuffledGame.pairsLeft = pairsLeft;
                shuffledGame.pairsRight = pairsRight;
            }

            return shuffledGame;
        }

        // Connexion Superviseur
        document.getElementById('supervisor-login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const password = document.getElementById('supervisor-password').value;
            if (password === SUPERVISOR_PASSWORD) {
                userRole = 'supervisor';
                sessionId = 'session_' + generateUUID();
                initializeSupervisor();
            } else {
                document.getElementById('login-error').classList.remove('hidden');
                setTimeout(() => document.getElementById('login-error').classList.add('hidden'), 3000);
            }
        });

        function initializeSupervisor() {
            showScreen('supervisor-dashboard');
            document.getElementById('session-id-display').textContent = sessionId;

            const qrContainer = document.getElementById('qrcode-container');
            qrContainer.innerHTML = '';
            const traineeUrl = window.location.href.split('?')[0] + '?session=' + sessionId;
            new QRCode(qrContainer, {
                text: traineeUrl,
                width: 256,
                height: 256,
                colorDark: '#5D5CDE',
                colorLight: '#ffffff',
                correctLevel: QRCode.CorrectLevel.H
            });

            database.ref('sessions/' + sessionId).set({
                status: 'waiting',
                currentBox: -1,
                currentGameIndex: -1,
                teams: {},
                openedBoxes: [],
                createdAt: Date.now()
            });

            database.ref('sessions/' + sessionId + '/teams').on('value', (snapshot) => {
                updateTeamsList(snapshot.val());
            });
        }

        function updateTeamsList(teams) {
            const teamsList = document.getElementById('teams-list');
            const teamsCount = document.getElementById('teams-count');

            if (!teams || Object.keys(teams).length === 0) {
                teamsList.innerHTML = '<div class="text-center text-gray-500 dark:text-gray-400">En attente des √©quipes...</div>';
                teamsCount.textContent = '0';
                return;
            }

            const teamsArray = Object.entries(teams);
            teamsCount.textContent = teamsArray.length;

            teamsList.innerHTML = teamsArray.map(([id, team]) => {
                const teamName = (team && team.name) ? team.name : 'undefined';
                const teamScore = (team && team.score) ? team.score : 0;

                return `
                <div class="bg-white dark:bg-gray-700 p-4 rounded-lg shadow-lg text-center relative">
                    <button onclick="removeTeam('${id}')" class="absolute top-2 right-2 w-8 h-8 bg-red-500 hover:bg-red-600 text-white rounded-full font-bold text-sm shadow-lg transition-all">‚úï</button>
                    <div class="text-3xl mb-2">${getTeamEmoji(id)}</div>
                    <div class="text-lg font-bold text-gray-800 dark:text-white">${teamName}</div>
                    <div class="text-sm text-gray-600 dark:text-gray-400">Score: ${teamScore} pts</div>
                </div>
            `;
            }).join('');
        }

        window.removeTeam = function(teamId) {
            showConfirmDialog('Voulez-vous vraiment supprimer cette √©quipe ?', () => {
                database.ref('sessions/' + sessionId + '/teams/' + teamId).remove();
            });
        }

        document.getElementById('start-game-btn').addEventListener('click', () => {
            database.ref('sessions/' + sessionId + '/status').set('playing');
            showBoxesScreen();
        });

        function showBoxesScreen() {
            showScreenSafe('boxes-screen');
            database.ref('sessions/' + sessionId + '/openedBoxes').once('value', (snapshot) => {
                openedBoxes = snapshot.val() || [];
                renderBoxes();
            });
        }

        function renderBoxes() {
            const boxesContainer = document.getElementById('boxes-container');
            boxesContainer.innerHTML = BOXES_DATA.map((box, index) => {
                const isDisabled = openedBoxes.includes(index);
                return `
                    <div class="glass-morphism rounded-3xl shadow-2xl p-8 text-center transform transition-all ${isDisabled ? 'box-disabled' : 'cursor-pointer hover:scale-105'}" onclick="${isDisabled ? '' : `openBox(${index})`}">
                        <div class="text-8xl mb-4 float">${box.icon}</div>
                        <h3 class="text-2xl font-bold text-gray-800 dark:text-white mb-2">${box.title}</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">${box.subtitle}</p>
                        <div class="bg-gradient-to-r ${box.color} text-white px-6 py-3 rounded-xl font-bold text-lg mt-4">
                            ${isDisabled ? '‚úÖ Termin√©' : '7 questions'}
                        </div>
                    </div>
                `;
            }).join('');
        }

        window.openBox = function(boxIndex) {
            currentBox = boxIndex;
            currentGameIndex = 0;

            const randomizedGames = getRandomizedGames(boxIndex);

            database.ref('sessions/' + sessionId).update({
                currentBox: boxIndex,
                currentGameIndex: 0,
                gameStatus: 'question',
                randomizedGames: randomizedGames
            });

            loadGame();
        }

        function loadGame() {
            console.log('üîÑ Question', currentGameIndex);

            database.ref('sessions/' + sessionId + '/randomizedGames').once('value', (snapshot) => {
                const games = snapshot.val();
                if (!games || !games[currentGameIndex]) return;

                let game = games[currentGameIndex];
                const preparedGame = prepareGameWithShuffledAnswers(game);

                resetAnswersFlags().then(() => {
                    console.log('‚úÖ Flags hasAnswered r√©initialis√©s');

                    return database.ref('sessions/' + sessionId).update({
                        answersCount: 0,
                        currentGame: preparedGame,
                        currentGameIndex: currentGameIndex,
                        gameStatus: 'question',
                        questionTimestamp: Date.now()
                    });
                }).then(() => {
                    showProjectorQuestion(preparedGame);
                    setTimeout(() => {
                        startAnswersCountListener();
                        console.log('‚úÖ Question pr√™te - Listener actif!');
                    }, 500);
                });
            });
        }

        function resetAnswersFlags() {
            return database.ref('sessions/' + sessionId + '/teams').once('value').then((snapshot) => {
                const teams = snapshot.val();
                if (!teams) return Promise.resolve();

                const updates = {};
                Object.keys(teams).forEach(id => {
                    updates['sessions/' + sessionId + '/teams/' + id + '/hasAnswered'] = false;
                    updates['sessions/' + sessionId + '/teams/' + id + '/answer'] = null;
                    updates['sessions/' + sessionId + '/teams/' + id + '/isCorrect'] = false;
                    updates['sessions/' + sessionId + '/teams/' + id + '/lastPoints'] = 0;
                });

                console.log('üîÑ R√©initialisation des flags pour', Object.keys(teams).length, '√©quipes');
                return database.ref().update(updates);
            });
        }

        function showProjectorQuestion(game) {
            showScreenSafe('projector-question');
            document.getElementById('projector-game-icon').textContent = getGameIcon(game.type);
            document.getElementById('projector-question-text').textContent = game.question;

            const container = document.getElementById('projector-game-container');
            container.innerHTML = renderGameForProjector(game);

            startQuestionTimer();
        }

        function getGameIcon(type) {
            const icons = { 'quiz': '‚ùì', 'true-false': '‚úì‚úó', 'sequence': 'üî¢', 'matching': 'üîó' };
            return icons[type] || 'üéØ';
        }

        function renderGameForProjector(game) {
            if (game.type === 'quiz' || game.type === 'true-false') {
                return `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        ${game.optionsWithIndex.map((opt, i) => `
                            <div class="bg-gradient-to-r from-blue-500 to-cyan-600 text-white p-6 rounded-xl text-xl font-bold text-center">
                                ${String.fromCharCode(65 + i)}. ${opt.text}
                            </div>
                        `).join('')}
                    </div>
                `;
            } else if (game.type === 'sequence') {
                return `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        ${game.itemsWithIndex.map((item, i) => `
                            <div class="bg-gradient-to-r from-purple-500 to-pink-600 text-white p-6 rounded-xl text-xl font-bold text-center">
                                ${i + 1}. ${item.text}
                            </div>
                        `).join('')}
                    </div>
                `;
            } else if (game.type === 'matching') {
                return `
                    <div class="grid grid-cols-2 gap-8">
                        <div class="space-y-4">
                            ${game.pairsLeft.map((pair, i) => `
                                <div class="bg-gradient-to-r from-blue-500 to-cyan-600 text-white p-4 rounded-xl text-lg font-bold text-center">
                                    ${pair.text}
                                </div>
                            `).join('')}
                        </div>
                        <div class="space-y-4">
                            ${game.pairsRight.map((pair, i) => `
                                <div class="bg-gradient-to-r from-purple-500 to-pink-600 text-white p-4 rounded-xl text-lg font-bold text-center">
                                    ${pair.text}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
        }

        function startAnswersCountListener() {
            database.ref('sessions/' + sessionId + '/teams').once('value', (snapshot) => {
                const teams = snapshot.val();
                if (!teams) return;

                const totalTeams = Object.keys(teams).length;
                console.log('üë• Total √©quipes attendues:', totalTeams);

                answersListener = (snapshot) => {
                    const count = snapshot.val() || 0;
                    console.log('üìä R√©ponses re√ßues:', count, '/', totalTeams, '√†', new Date().toLocaleTimeString());

                    document.getElementById('answered-count').textContent = count;
                    document.getElementById('total-teams-count').textContent = totalTeams;

                    if (count >= totalTeams && totalTeams > 0) {
                        console.log('‚úÖ TOUT LE MONDE A R√âPONDU! Passage √† la correction');
                        
                        if (timerInterval) {
                            clearInterval(timerInterval);
                            timerInterval = null;
                        }
                        
                        if (answersListener) {
                            database.ref('sessions/' + sessionId + '/answersCount').off('value', answersListener);
                            answersListener = null;
                        }
                        
                        showCorrection();
                    }
                };

                database.ref('sessions/' + sessionId + '/answersCount').on('value', answersListener);
                console.log('‚úÖ Listener answersCount ACTIV√â');
            });
        }

        function showCorrection() {
            console.log('üîÑ Appel de showCorrection()');
            
            database.ref('sessions/' + sessionId + '/randomizedGames').once('value', (snapshot) => {
                const games = snapshot.val();
                const game = games[currentGameIndex];

                console.log('üìä Calcul des scores pour:', game.question);
                calculateAndUpdateScores(game);

                setTimeout(() => {
                    console.log('üì° Envoi du statut "correction" √† Firebase');
                    
                    database.ref('sessions/' + sessionId + '/gameStatus').set('correction').then(() => {
                        console.log('‚úÖ Statut "correction" CONFIRM√â par Firebase');
                        
                        setTimeout(() => {
                            console.log('üì∫ Affichage de l\'√©cran correction (superviseur)');
                            showScreenSafe('projector-correction');
                            document.getElementById('projector-explanation').textContent = game.explanation || 'Bonne r√©ponse !';

                            const container = document.getElementById('projector-correction-content');
                            container.innerHTML = renderCorrection(game);
                        }, 500);
                    }).catch(error => {
                        console.error('‚ùå Erreur envoi statut correction:', error);
                    });
                }, 300);
            });
        }

        function renderCorrection(game) {
            if (game.type === 'quiz' || game.type === 'true-false') {
                return `
                    <div class="space-y-3">
                        ${game.optionsWithIndex.map((opt, i) => `
                            <div class="p-4 rounded-xl text-lg font-bold ${opt.originalIndex === game.correctAnswer ? 'bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200' : 'bg-gray-100 dark:bg-gray-700'}">
                                ${opt.originalIndex === game.correctAnswer ? '‚úì' : ''} ${String.fromCharCode(65 + i)}. ${opt.text}
                            </div>
                        `).join('')}
                    </div>
                `;
            } else if (game.type === 'sequence') {
                return `
                    <div class="space-y-3">
                        ${game.itemsWithIndex.map((item, i) => `
                            <div class="bg-green-100 dark:bg-green-900 p-4 rounded-xl text-lg font-bold text-green-800 dark:text-green-200">
                                ${i + 1}. ${item.text}
                            </div>
                        `).join('')}
                    </div>
                `;
            } else if (game.type === 'matching') {
                return `
                    <div class="space-y-3">
                        ${game.pairsLeft.map((pair, i) => `
                            <div class="bg-green-100 dark:bg-green-900 p-4 rounded-xl text-lg font-bold text-green-800 dark:text-green-200">
                                ‚úì ${pair.text} ‚Üí ${game.pairsRight.find(r => r.originalIndex === pair.originalIndex).text}
                            </div>
                        `).join('')}
                    </div>
                `;
            }
        }

        function calculateAndUpdateScores(game) {
            database.ref('sessions/' + sessionId + '/teams').once('value', (snapshot) => {
                const teams = snapshot.val();
                if (!teams) return;

                Object.entries(teams).forEach(([id, team]) => {
                    let points = 0;
                    
                    if (team.isCorrect === true) {
                        points = 150;
                    }
                    
                    console.log('üìä √âquipe:', team.name, '| isCorrect:', team.isCorrect, '| Points:', points);
                    
                    const newScore = (team.score || 0) + points;
                    
                    database.ref('sessions/' + sessionId + '/teams/' + id).update({
                        score: newScore,
                        lastPoints: points
                    });
                });
            });
        }

        document.getElementById('next-question-btn').addEventListener('click', () => {
            currentGameIndex++;
            console.log('üìç Passage √† la question:', currentGameIndex);

            database.ref('sessions/' + sessionId + '/randomizedGames').once('value', (snapshot) => {
                const games = snapshot.val();

                if (!games) {
                    console.error('‚ùå Pas de jeux trouv√©s!');
                    return;
                }

                console.log('üìä Questions dans ce coffre:', games.length, 'Question actuelle:', currentGameIndex);

                if (currentGameIndex >= games.length) {
                    console.log('‚úÖ Coffre termin√©! Coffre:', currentBox);

                    if (!openedBoxes.includes(currentBox)) {
                        openedBoxes.push(currentBox);
                    }
                    database.ref('sessions/' + sessionId + '/openedBoxes').set(openedBoxes);

                    if (currentBox < BOXES_DATA.length - 1) {
                        console.log('‚è∏Ô∏è Pause avant coffre suivant');
                        showPauseScreen();
                    } else {
                        console.log('üèÜ Tous les coffres termin√©s - Podium!');
                        showPodium();
                    }
                } else {
                    console.log('‚û°Ô∏è Question suivante dans le m√™me coffre');
                    loadGame();
                }
            });
        });

        function showPauseScreen() {
            showScreenSafe('pause-screen');
            database.ref('sessions/' + sessionId + '/gameStatus').set('pause');

            document.getElementById('pause-box-number').textContent = currentBox + 1;
            document.getElementById('next-box-number').textContent = currentBox + 2;

            displayRanking('pause-ranking');
        }

        document.getElementById('next-box-btn').addEventListener('click', () => {
            database.ref('sessions/' + sessionId + '/gameStatus').set('boxes');
            showBoxesScreen();
        });

        function displayRanking(containerId) {
            database.ref('sessions/' + sessionId + '/teams').once('value', (snapshot) => {
                const teams = snapshot.val();
                if (!teams) return;

                const teamsArray = Object.entries(teams).map(([id, team]) => ({
                    id,
                    name: team && team.name ? team.name : '√âquipe inconnue',
                    score: team && team.score ? team.score : 0
                })).sort((a, b) => b.score - a.score);

                const container = document.getElementById(containerId);
                container.innerHTML = teamsArray.map((team, i) => `
                    <div class="flex items-center justify-between p-4 ${i < 3 ? 'bg-gradient-to-r from-yellow-100 to-yellow-200 dark:from-yellow-900 dark:to-yellow-800' : 'bg-gray-100 dark:bg-gray-700'} rounded-lg mb-2">
                        <div class="flex items-center gap-4">
                            <div class="ranking-badge rank-${i < 3 ? i + 1 : 'other'}">${i + 1}</div>
                            <div class="text-xl font-bold">${team.name}</div>
                        </div>
                        <div class="text-2xl font-bold text-primary">${team.score} pts</div>
                    </div>
                `).join('');
            });
        }

        function showPodium() {
            showScreenSafe('podium-screen');
            database.ref('sessions/' + sessionId + '/gameStatus').set('finished');
            createConfetti();

            database.ref('sessions/' + sessionId + '/teams').once('value', (snapshot) => {
                const teams = snapshot.val();
                if (!teams) return;

                const teamsArray = Object.entries(teams).map(([id, team]) => ({
                    id,
                    name: team && team.name ? team.name : '√âquipe inconnue',
                    score: team && team.score ? team.score : 0
                })).sort((a, b) => b.score - a.score);

                const podiumContainer = document.getElementById('podium-container');
                podiumContainer.innerHTML = '';

                if (teamsArray.length >= 2) {
                    podiumContainer.innerHTML += `
                        <div class="text-center"><div class="text-6xl mb-2">ü•à</div><div class="bg-gradient-to-r from-gray-300 to-gray-400 text-white p-6 rounded-t-xl" style="height: 200px; display: flex; flex-direction: column; justify-content: center;"><div class="text-2xl font-bold">${teamsArray[1].name}</div><div class="text-4xl font-bold">${teamsArray[1].score} pts</div></div></div>
                    `;
                }

                if (teamsArray.length >= 1) {
                    podiumContainer.innerHTML += `
                        <div class="text-center"><div class="text-8xl mb-2">ü•á</div><div class="bg-gradient-to-r from-yellow-400 to-yellow-600 text-white p-8 rounded-t-xl" style="height: 300px; display: flex; flex-direction: column; justify-content: center;"><div class="text-3xl font-bold">${teamsArray[0].name}</div><div class="text-5xl font-bold">${teamsArray[0].score} pts</div></div></div>
                    `;
                }

                if (teamsArray.length >= 3) {
                    podiumContainer.innerHTML += `
                        <div class="text-center"><div class="text-6xl mb-2">ü•â</div><div class="bg-gradient-to-r from-orange-400 to-orange-600 text-white p-4 rounded-t-xl" style="height: 150px; display: flex; flex-direction: column; justify-content: center;"><div class="text-xl font-bold">${teamsArray[2].name}</div><div class="text-3xl font-bold">${teamsArray[2].score} pts</div></div></div>
                    `;
                }

                displayRanking('full-ranking-list');
            });
        }

        // Connexion Stagiaire - avec auto-reconnexion
        window.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const sessionParam = urlParams.get('session');
            const teamParam = urlParams.get('team');

            if (sessionParam) {
                sessionId = sessionParam;

                if (teamParam) {
                    console.log('üîç Tentative de reconnexion...', { sessionId: sessionParam, teamId: teamParam });

                    checkTeamExists(sessionParam, teamParam).then(teamData => {
                        if (teamData) {
                            teamId = teamParam;
                            reconnectToSession(sessionParam, teamParam, teamData);
                        } else {
                            console.log('‚ùå √âquipe inexistante, affichage login');
                            clearSessionFromURL();
                            userRole = 'trainee';
                            showScreenSafe('trainee-login');
                        }
                    }).catch(error => {
                        console.error('‚ùå Erreur reconnexion:', error);
                        userRole = 'trainee';
                        showScreenSafe('trainee-login');
                    });
                } else {
                    userRole = 'trainee';
                    showScreenSafe('trainee-login');
                }
            }
        });

        document.getElementById('join-game-btn').addEventListener('click', () => {
            teamName = document.getElementById('team-name-input').value.trim();

            if (!teamName) {
                showCustomAlert('Veuillez entrer un nom d\'√©quipe');
                return;
            }

            teamId = 'team_' + generateUUID();

            const teamRef = database.ref('sessions/' + sessionId + '/teams/' + teamId);

            teamRef.set({
                name: teamName,
                score: 0,
                hasAnswered: false,
                joinedAt: Date.now()
            }).then(() => {
                console.log('‚úÖ √âquipe cr√©√©e:', teamName, teamId);

                teamRef.onDisconnect().remove();
                console.log('üîå Listener de d√©connexion activ√© pour:', teamName);

                saveTraineeSessionToURL();

                enableTraineeScrollProtection();

                showScreenSafe('trainee-waiting');
                document.getElementById('trainee-team-name-display').textContent = teamName;

                database.ref('sessions/' + sessionId + '/status').on('value', (snapshot) => {
                    const status = snapshot.val();
                    if (status === 'playing') {
                        listenForGameUpdatesTrainee();
                    }
                });
            }).catch((error) => {
                console.error('‚ùå Erreur cr√©ation √©quipe:', error);
                showCustomAlert('Erreur lors de la connexion. R√©essayez.');
            });
        });

        function listenForGameUpdatesTrainee() {
            cleanupAllFirebaseListeners();

            if (gameStatusListener) {
                database.ref('sessions/' + sessionId + '/gameStatus').off('value', gameStatusListener);
            }
            if (currentGameListener) {
                database.ref('sessions/' + sessionId + '/currentGame').off('value', currentGameListener);
            }

            console.log('üéØ D√©marrage de listenForGameUpdatesTrainee');

            gameStatusListener = (snapshot) => {
                const gameStatus = snapshot.val();
                console.log('üì° gameStatus RE√áU:', gameStatus, 'Timestamp:', new Date().toLocaleTimeString());

                if (gameStatus === 'question') {
                    console.log('‚ùì Question re√ßue - Attente du currentGame');
                    
                    if (currentGameListener) {
                        database.ref('sessions/' + sessionId + '/currentGame').off('value', currentGameListener);
                    }

                    currentGameListener = (snap) => {
                        const game = snap.val();
                        if (game) {
                            console.log('üì± STAGIAIRE RE√áOIT LA QUESTION:', game.question);
                            showTraineeGame(game);
                        }
                    };
                    database.ref('sessions/' + sessionId + '/currentGame').on('value', currentGameListener);
                } 
                else if (gameStatus === 'correction') {
                    console.log('‚úÖ CORRECTION RE√áUE - Affichage du r√©sultat');
                    
                    if (currentGameListener) {
                        database.ref('sessions/' + sessionId + '/currentGame').off('value', currentGameListener);
                        currentGameListener = null;
                    }
                    
                    setTimeout(() => {
                        showTraineeResult();
                    }, 300);
                } 
                else if (gameStatus === 'pause' || gameStatus === 'boxes') {
                    console.log('üèÜ CLASSEMENT/PAUSE RE√áU');
                    if (currentGameListener) {
                        database.ref('sessions/' + sessionId + '/currentGame').off('value', currentGameListener);
                        currentGameListener = null;
                    }
                    showScreenSafe('ranking-screen');
                    displayRanking('ranking-list');
                } 
                else if (gameStatus === 'finished') {
                    console.log('üèÜ PODIUM RE√áU');
                    if (currentGameListener) {
                        database.ref('sessions/' + sessionId + '/currentGame').off('value', currentGameListener);
                        currentGameListener = null;
                    }
                    showScreenSafe('podium-screen');
                    showPodium();
                }
            };

            database.ref('sessions/' + sessionId + '/gameStatus').on('value', gameStatusListener);
            console.log('‚úÖ Listener gameStatus ACTIV√â');
        }

        function showTraineeGame(game) {
            showScreenSafe('trainee-game');

            document.getElementById('trainee-team-display').textContent = teamName;

            database.ref('sessions/' + sessionId + '/teams/' + teamId + '/score').on('value', (snapshot) => {
                const score = snapshot.val() || 0;
                document.getElementById('trainee-score-display').textContent = score + ' pts';
            });

            const container = document.getElementById('trainee-game-container');
            container.innerHTML = renderGameForTraineeNOSHUFFLE(game);

            selectedAnswer = null;
            selectedSequence = [];
            selectedMatching = [];

            const btn = document.getElementById('trainee-validate-btn');
            btn.disabled = false;
            btn.textContent = '‚úì Valider ma r√©ponse';
            btn.classList.remove('opacity-50', 'cursor-not-allowed');
            btn.onclick = () => validateTraineeAnswer(game);
        }

        function renderGameForTraineeNOSHUFFLE(game) {
            if (game.type === 'quiz' || game.type === 'true-false') {
                return `
                    <div class="text-2xl font-bold text-center mb-6 text-gray-800 dark:text-white">Choisissez votre r√©ponse :</div>
                    <div class="grid grid-cols-1 gap-4">
                        ${game.optionsWithIndex.map((item, displayIndex) => `
                            <div class="answer-option bg-white dark:bg-gray-700 p-6 rounded-xl text-xl font-bold text-center shadow-lg" 
                                 data-original-index="${item.originalIndex}" 
                                 onclick="selectAnswer(${item.originalIndex})">
                                ${String.fromCharCode(65 + displayIndex)}. ${item.text}
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            else if (game.type === 'sequence') {
                return `
                    <div class="text-2xl font-bold text-center mb-6 text-gray-800 dark:text-white">Cliquez dans l'ordre :</div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="sequence-container">
                        ${game.itemsWithIndex.map((item) => `
                            <div class="sequence-item bg-gradient-to-r from-purple-500 to-pink-600 text-white p-6 rounded-xl text-lg font-bold text-center shadow-lg" 
                                 data-original-index="${item.originalIndex}" 
                                 onclick="selectSequenceItem(${item.originalIndex})">
                                ${item.text}
                            </div>
                        `).join('')}
                    </div>
                    <div class="mt-6 p-4 bg-white dark:bg-gray-700 rounded-xl shadow-lg">
                        <div class="text-lg font-bold mb-2">Votre ordre :</div>
                        <div id="selected-sequence-display" class="text-gray-600 dark:text-gray-400">Aucune s√©lection</div>
                    </div>
                `;
            }
            
            else if (game.type === 'matching') {
                return `
                    <div class="text-2xl font-bold text-center mb-6 text-gray-800 dark:text-white">Associez les paires :</div>
                    <div class="grid grid-cols-2 gap-6">
                        <div class="space-y-3" id="matching-left">
                            ${game.pairsLeft.map((item) => `
                                <div class="matching-item bg-gradient-to-r from-blue-500 to-cyan-600 text-white p-4 rounded-xl text-lg font-bold text-center shadow-lg" 
                                     data-side="left" 
                                     data-index="${item.originalIndex}" 
                                     onclick="selectMatchingItem('left', ${item.originalIndex})">
                                    ${item.text}
                                </div>
                            `).join('')}
                        </div>
                        <div class="space-y-3" id="matching-right">
                            ${game.pairsRight.map((item) => `
                                <div class="matching-item bg-gradient-to-r from-purple-500 to-pink-600 text-white p-4 rounded-xl text-lg font-bold text-center shadow-lg" 
                                     data-side="right" 
                                     data-index="${item.originalIndex}" 
                                     onclick="selectMatchingItem('right', ${item.originalIndex})">
                                    ${item.text}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="mt-6 p-4 bg-white dark:bg-gray-700 rounded-xl shadow-lg">
                        <div class="text-lg font-bold mb-2">Paires form√©es : <span id="pairs-count">0/${game.pairsLeft.length}</span></div>
                    </div>
                `;
            }
        }

        window.selectAnswer = function(originalIndex) {
            console.log('üîç Clic sur r√©ponse:', originalIndex);

            document.querySelectorAll('.answer-option').forEach(opt => opt.classList.remove('selected'));

            const option = document.querySelector(`.answer-option[data-original-index="${originalIndex}"]`);
            if (option) {
                option.classList.add('selected');
                selectedAnswer = originalIndex;
                console.log('‚úÖ R√©ponse s√©lectionn√©e:', originalIndex);
            }
        }

        window.selectSequenceItem = function(originalIndex) {
            console.log('üîç Clic sur item:', originalIndex);

            const indexPos = selectedSequence.indexOf(originalIndex);

            if (indexPos !== -1) {
                console.log('‚ùå D√©s√©lection', originalIndex);
                selectedSequence.splice(indexPos, 1);
            } else {
                console.log('‚úÖ S√©lection', originalIndex);
                selectedSequence.push(originalIndex);
            }

            document.querySelectorAll('.sequence-item').forEach(el => {
                const idx = parseInt(el.getAttribute('data-original-index'));
                const pos = selectedSequence.indexOf(idx);

                el.classList.remove('selected');
                const oldNum = el.querySelector('.order-number');
                if (oldNum) oldNum.remove();

                if (pos !== -1) {
                    el.classList.add('selected');
                    const orderDiv = document.createElement('div');
                    orderDiv.className = 'order-number';
                    orderDiv.textContent = pos + 1;
                    el.appendChild(orderDiv);
                }
            });

            database.ref('sessions/' + sessionId + '/currentGame').once('value', (snapshot) => {
                const game = snapshot.val();
                const selectedItems = selectedSequence.map(i => game.itemsWithIndex[game.itemsWithIndex.findIndex(x => x.originalIndex === i)].text);
                document.getElementById('selected-sequence-display').textContent = selectedItems.join(' ‚Üí ') || 'Aucune s√©lection';
                console.log('üìù Ordre:', selectedSequence);
            });
        }

        window.selectMatchingItem = function(side, index) {
            const item = document.querySelector(`.matching-item[data-side="${side}"][data-index="${index}"]`);

            if (item.classList.contains('matched')) return;

            if (item.classList.contains('selected')) {
                item.classList.remove('selected');
                selectedMatching = selectedMatching.filter(m => !(m.side === side && m.index === index));
            } else {
                item.classList.add('selected');
                selectedMatching.push({ side, index });

                if (selectedMatching.length === 2) {
                    if (selectedMatching[0].side !== selectedMatching[1].side) {
                        selectedMatching.forEach(m => {
                            const el = document.querySelector(`.matching-item[data-side="${m.side}"][data-index="${m.index}"]`);
                            el.classList.remove('selected');
                            el.classList.add('matched');
                        });
                    }

                    selectedMatching = [];

                    const matched = document.querySelectorAll('.matching-item.matched').length / 2;
                    database.ref('sessions/' + sessionId + '/currentGame').once('value', (snapshot) => {
                        const game = snapshot.val();
                        document.getElementById('pairs-count').textContent = `${matched}/${game.pairsLeft.length}`;
                    });
                }
            }
        }

        function validateTraineeAnswer(game) {
            const btn = document.getElementById('trainee-validate-btn');
            if (btn.disabled) return;
            btn.disabled = true;
            btn.textContent = '‚è≥ Envoi en cours...';
            btn.classList.add('opacity-50', 'cursor-not-allowed');

            let answer = null;
            let isCorrect = false;

            if (game.type === 'quiz' || game.type === 'true-false') {
                answer = selectedAnswer;
                isCorrect = (selectedAnswer === game.correctAnswer);
            } else if (game.type === 'sequence') {
                answer = selectedSequence;
                isCorrect = JSON.stringify(selectedSequence) === JSON.stringify(game.correctOrder);
            } else if (game.type === 'matching') {
                const matchedPairs = [];
                document.querySelectorAll('.matching-item.matched').forEach(el => {
                    const side = el.getAttribute('data-side');
                    const index = parseInt(el.getAttribute('data-index'));
                    if (!matchedPairs.find(p => p.side === side && p.index === index)) {
                        matchedPairs.push({ side, index });
                    }
                });
                answer = matchedPairs;
                isCorrect = (matchedPairs.length === game.pairsLeft.length);
            }

            console.log('üì§ Envoi de la r√©ponse:', { answer, isCorrect });

            database.ref('sessions/' + sessionId + '/teams/' + teamId).update({
                hasAnswered: true,
                answer: answer,
                isCorrect: isCorrect
            }).then(() => {
                console.log('‚úÖ R√©ponse sauvegard√©e avec isCorrect:', isCorrect);
                const countRef = database.ref('sessions/' + sessionId + '/answersCount');
                return countRef.transaction((currentCount) => {
                    return (currentCount || 0) + 1;
                });
            }).then(() => {
                console.log('‚úÖ Compteur incr√©ment√©!');
                showScreenSafe('trainee-waiting-others');
            }).catch((error) => {
                console.error('‚ùå Erreur envoi r√©ponse:', error);
                btn.disabled = false;
                btn.textContent = '‚úì Valider ma r√©ponse';
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
                showCustomAlert('Erreur lors de l\'envoi. R√©essayez.');
            });
        }

        function showTraineeResult() {
            showScreenSafe('trainee-result');

            database.ref('sessions/' + sessionId + '/teams/' + teamId).once('value', (snapshot) => {
                const team = snapshot.val();

                if (!team) {
                    console.error('‚ùå √âquipe non trouv√©e:', teamId);
                    return;
                }

                const points = team.lastPoints || 0;
                const hasAnswered = team.hasAnswered || false;
                const answer = team.answer;

                console.log('üìä R√©sultat stagiaire:', { points, hasAnswered, answer, isCorrect: team.isCorrect });

                if (!hasAnswered || answer === null || answer === undefined) {
                    document.getElementById('trainee-result-icon').textContent = '‚è∞';
                    document.getElementById('trainee-result-title').textContent = 'Temps √©coul√© !';
                    document.getElementById('trainee-result-title').className = 'text-5xl md:text-6xl font-bold mb-6 text-orange-600';
                    document.getElementById('trainee-points-earned').textContent = '0';
                } else if (points > 0) {
                    document.getElementById('trainee-result-icon').textContent = '‚úì';
                    document.getElementById('trainee-result-title').textContent = 'Bonne r√©ponse !';
                    document.getElementById('trainee-result-title').className = 'text-5xl md:text-6xl font-bold mb-6 text-green-600';
                    document.getElementById('trainee-points-earned').textContent = '+' + points;
                } else {
                    document.getElementById('trainee-result-icon').textContent = '‚úó';
                    document.getElementById('trainee-result-title').textContent = 'Mauvaise r√©ponse';
                    document.getElementById('trainee-result-title').className = 'text-5xl md:text-6xl font-bold mb-6 text-red-600';
                    document.getElementById('trainee-points-earned').textContent = '0';
                }

                document.getElementById('trainee-total-score').textContent = (team.score || 0) + ' pts';
            });
        }

        document.getElementById('reset-game-btn').addEventListener('click', () => {
            showConfirmDialog('Voulez-vous vraiment r√©initialiser la session ?', () => {
                database.ref('sessions/' + sessionId).remove();
                location.reload();
            });
        });

        document.getElementById('restart-game-btn').addEventListener('click', () => {
            database.ref('sessions/' + sessionId).remove();
            location.reload();
        });

    </script>
</body>
</html>
